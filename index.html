<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Minha Cole√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="data:,">

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#fff;
  color:#111;
}
.wrap{max-width:1100px;margin:auto;padding:16px}
h1{margin:0;font-weight:600}
.sub{color:#666;font-size:.9rem;margin-bottom:12px}

.btn{
  padding:8px 14px;
  border-radius:999px;
  border:1px solid #ddd;
  background:#f8f8f8;
  cursor:pointer;
  font-weight:600;
}
.btn.primary{background:#4f46e5;color:#fff;border:none}

.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}
@media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.grid{grid-template-columns:1fr}}

.card{
  display:flex;
  gap:10px;
  border:1px solid #eee;
  border-radius:14px;
  padding:10px;
  cursor:pointer;
}
.poster{
  width:80px;
  height:120px;
  background:#eee;
  border-radius:10px;
  overflow:hidden;
}
.poster img{width:100%;height:100%;object-fit:cover}

.title{
  font-weight:600;
  line-height:1.2;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.meta{color:#666;font-size:.8rem;margin-top:4px}
.footer{
  margin-top:6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.status{
  font-size:.7rem;
  padding:3px 8px;
  border-radius:999px;
}
.ASSISTIDOS{background:#dcfce7;color:#15803d}
.ASSISTINDO{background:#eef2ff;color:#4338ca}
.AINDA_NAO_COMECEI{background:#fef3c7;color:#92400e}

/* TOPS */
.tops{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin-bottom:16px;
}
@media(max-width:900px){.tops{grid-template-columns:1fr}}

.topBox{
  border:1px solid #eee;
  border-radius:14px;
}
.topHead{
  padding:8px 10px;
  background:#fafafa;
  border-bottom:1px solid #eee;
  font-weight:600;
}
.topItem{
  padding:8px 10px;
  border-bottom:1px solid #f1f1f1;
  cursor:pointer;
  font-size:.85rem;
}
.topItem:last-child{border-bottom:0}

/* MODAL */
.backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
}
.backdrop.show{display:flex}

.modal{
  background:#fff;
  width:90%;
  max-width:700px;
  max-height:90vh;
  border-radius:16px;
  display:flex;
  flex-direction:column;
}
.modalHeader,
.modalFooter{
  padding:10px;
  border-bottom:1px solid #eee;
}
.modalFooter{border-top:1px solid #eee;border-bottom:none}
.modalBody{
  padding:10px;
  overflow:auto;
}

label{font-size:.75rem;color:#666}
input,textarea,select{
  width:100%;
  padding:8px;
  border-radius:10px;
  border:1px solid #ddd;
}
.stars{font-size:1.3rem;cursor:pointer}
</style>
</head>

<body>
<div class="wrap">
  <h1>üé¨ Minha Cole√ß√£o</h1>
  <div class="sub">Vers√£o est√°vel local</div>

  <div class="tops">
    <div class="topBox">
      <div class="topHead">‚≠ê Top 10</div>
      <div id="topBest"></div>
    </div>
    <div class="topBox">
      <div class="topHead">‚¨áÔ∏è Piores</div>
      <div id="topWorst"></div>
    </div>
    <div class="topBox">
      <div class="topHead">üÜï √öltimos</div>
      <div id="topLast"></div>
    </div>
  </div>

  <button class="btn primary" id="btnNovo">+ Nova m√≠dia</button>
  <div style="height:10px"></div>

  <div id="lista" class="grid"></div>
</div>

<div class="backdrop" id="backdrop">
  <div class="modal">
    <div class="modalHeader">
      <b id="modalTitle">Detalhes</b>
      <button class="btn" id="btnFechar">Fechar</button>
    </div>
    <div class="modalBody">
      <label>Nome</label>
      <input id="mNome">

      <label>Status</label>
      <select id="mStatus">
        <option value="ASSISTINDO">Assistindo</option>
        <option value="ASSISTIDOS">Assistidos</option>
        <option value="AINDA_NAO_COMECEI">Ainda n√£o comecei</option>
      </select>

      <label>Avalia√ß√£o</label>
      <div class="stars" id="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
      <input id="mAvaliacao" placeholder="0,5 ‚Äì 5">

      <label>Sinopse</label>
      <textarea id="mSinopse"></textarea>
    </div>
    <div class="modalFooter">
      <button class="btn primary" id="btnSalvar">Salvar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.6/dist/umd/supabase.min.js"></script>
<script>
console.log("VERSAO LOCAL OK");

const SUPABASE_URL = "https://koytoiwfvwzjvgcqhlal.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtveXRvaXdmdnd6anZnY3FobGFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDExNzAsImV4cCI6MjA3OTcxNzE3MH0.mrMRUGJFqzOBjj7M4giHcWr5qsqUn_0woVMFikDxrjM";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function sanitize(v){
  if(!v) return null;
  v=String(v).replace(",",".");
  let n=Number(v);
  if(!isFinite(n)) return null;
  return Math.round(Math.max(0,Math.min(5,n))*2)/2;
}
function stars(v){
  const n=sanitize(v);
  if(n==null) return "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
  return "‚òÖ".repeat(Math.floor(n))+(n%1?"‚Ø®":"")+"‚òÜ".repeat(5-Math.ceil(n));
}

let midias=[];
let current=null;

async function load(){
  const {data,error}=await db.from("midias").select("*").order("created_at",{ascending:false});
  if(error){console.error(error);alert("erro ao carregar midias");return;}
  midias=data||[];
  render();
}
load();

function render(){
  const best=[...midias].filter(m=>m.avaliacao!=null).sort((a,b)=>b.avaliacao-a.avaliacao).slice(0,10);
  const worst=[...midias].filter(m=>m.avaliacao!=null).sort((a,b)=>a.avaliacao-b.avaliacao).slice(0,10);
  const last=midias.slice(0,10);

  fill("topBest",best);
  fill("topWorst",worst);
  fill("topLast",last);

  const lista=document.getElementById("lista");
  lista.innerHTML="";
  midias.forEach(m=>{
    const c=document.createElement("div");
    c.className="card";
    c.onclick=()=>open(m);
    c.innerHTML=`
      <div class="poster"><img src="${m.imagem_url||""}"></div>
      <div>
        <div class="title">${m.nome}</div>
        <div class="meta">${m.ano||""}</div>
        <div class="footer">
          <span class="status ${m.status}">${m.status}</span>
          <span>${stars(m.avaliacao)}</span>
        </div>
      </div>`;
    lista.appendChild(c);
  });
}
function fill(id,list){
  const el=document.getElementById(id);
  el.innerHTML="";
  list.forEach(m=>{
    const d=document.createElement("div");
    d.className="topItem";
    d.textContent=`${m.nome} (${m.avaliacao})`;
    d.onclick=()=>open(m);
    el.appendChild(d);
  });
}

const backdrop=document.getElementById("backdrop");
function open(m){
  current=m;
  document.getElementById("modalTitle").textContent=m?"Editar":"Nova";
  document.getElementById("mNome").value=m?.nome||"";
  document.getElementById("mStatus").value=m?.status||"ASSISTINDO";
  document.getElementById("mAvaliacao").value=m?.avaliacao||"";
  document.getElementById("mSinopse").value=m?.sinopse||"";
  document.getElementById("stars").textContent=stars(m?.avaliacao);
  backdrop.classList.add("show");
}
document.getElementById("btnNovo").onclick=()=>open();
document.getElementById("btnFechar").onclick=()=>backdrop.classList.remove("show");

document.getElementById("btnSalvar").onclick=async()=>{
  const payload={
    nome:document.getElementById("mNome").value,
    status:document.getElementById("mStatus").value,
    avaliacao:sanitize(document.getElementById("mAvaliacao").value),
    sinopse:document.getElementById("mSinopse").value
  };
  if(current){
    await db.from("midias").update(payload).eq("id",current.id);
  }else{
    await db.from("midias").insert(payload);
  }
  backdrop.classList.remove("show");
  load();
};
</script>
</body>
</html>
