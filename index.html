<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Filmes e S√©ries ‚Äî Elenco (cast_data) integrado</title>
  <style>
    :root{
      --bg:#0f1115;
      --card:#151922;
      --card2:#10131a;
      --text:#e8ecf3;
      --muted:#aab3c2;
      --border:#232a39;
      --accent:#6aa6ff;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:14px;
      --danger:#ff7878;
      --ok:#78ffb4;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(900px 500px at 20% -10%, rgba(106,166,255,.16), transparent 60%),
                  radial-gradient(900px 500px at 85% 0%, rgba(120,255,180,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1200px;
      margin:26px auto;
      padding:0 16px 56px;
    }
    header{
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:16px;
    }
    h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
      font-weight:800;
    }
    .sub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 980px){
      .row{ grid-template-columns: 1.1fr .9fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.18);
      gap:12px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-size:12px;
      color: var(--muted);
    }
    .badge b{ color:var(--text); font-weight:800; }
    .content{ padding:16px; }

    .field{
      display:grid;
      gap:7px;
      margin-bottom:10px;
    }
    label{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    input, textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    textarea{ min-height: 92px; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    input::placeholder, textarea::placeholder{ color: rgba(170,179,194,.7); }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    button:hover{
      transform: translateY(-1px);
      border-color: rgba(106,166,255,.35);
      background: rgba(106,166,255,.10);
    }
    .btn-primary{
      border-color: rgba(106,166,255,.40);
      background: rgba(106,166,255,.14);
    }
    .btn-danger{
      border-color: rgba(255,120,120,.35);
      background: rgba(255,120,120,.10);
    }
    .pill{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(170,179,194,.35);
    }
    .dot.ok{ background: rgba(120,255,180,.65); }
    .dot.err{ background: rgba(255,120,120,.65); }

    /* Lista de m√≠dias */
    .list{
      display:grid;
      gap:10px;
    }
    .item{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .item:hover{
      transform: translateY(-1px);
      border-color: rgba(106,166,255,.35);
      background: rgba(106,166,255,.06);
    }
    .item .title{
      font-weight:900;
      font-size:14px;
      line-height:1.2;
      margin:0;
    }
    .item .meta{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.2;
    }
    .tag{
      font-size:12px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      white-space: nowrap;
    }

    /* Modal base */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.78);
      backdrop-filter: blur(6px);
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width:min(980px, 100%);
      max-height: min(90vh, 900px);
      background: rgba(18,22,30,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modal-head{
      padding:14px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: rgba(0,0,0,.18);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modal-title{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 0;
    }
    .modal-title h2{
      margin:0;
      font-size:16px;
      font-weight:900;
      letter-spacing:.2px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 720px;
    }
    .modal-title p{
      margin:0;
      font-size:13px;
      color: var(--muted);
      line-height:1.35;
    }
    .close{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      width:40px;height:40px;
      border-radius: 12px;
      cursor:pointer;
      display:grid;
      place-items:center;
      font-size:20px;
      line-height:0;
      user-select:none;
      flex: 0 0 auto;
    }
    .close:hover{
      border-color: rgba(106,166,255,.35);
      background: rgba(106,166,255,.10);
    }
    .modal-body{
      padding:14px;
      overflow:auto; /* ‚úÖ rolagem no modal */
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 980px){
      .modal-body{ grid-template-columns: 1fr 1fr; }
    }
    .box{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:12px;
    }
    .box-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .box-head h3{
      margin:0;
      font-size:13px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .muted{ color: var(--muted); font-size:12px; }

    /* ===== Elenco (grid) ===== */
    .cast-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
      gap:12px;
    }
    .cast-card{
      cursor:pointer;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:10px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:160px;
    }
    .cast-card:hover{
      transform: translateY(-1px);
      border-color: rgba(106,166,255,.35);
      background: rgba(106,166,255,.08);
    }
    .cast-photo{
      width:100%;
      aspect-ratio: 3/4;
      border-radius:10px;
      overflow:hidden;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);
    }
    .cast-photo img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .cast-name{
      font-size:13px;
      font-weight:800;
      line-height:1.15;
      margin:0;
    }
    .cast-role{
      font-size:12px;
      opacity:.8;
      line-height:1.15;
      margin:0;
    }

    /* ===== Modal zoom (cast) ===== */
    .cast-zoom-modal{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.78);
      backdrop-filter: blur(6px);
      z-index: 99999;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .cast-zoom-modal.show{ display:flex; }

    .cast-zoom-card{
      width:min(900px, 100%);
      max-height: 88vh;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(18,22,30,.94);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .cast-zoom-close{
      position:absolute;
      top:10px; right:10px;
      width:40px; height:40px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#fff;
      font-size:22px;
      cursor:pointer;
      font-weight:900;
    }
    .cast-zoom-body{
      padding:14px;
      overflow:auto; /* ‚úÖ rolagem se a imagem for gigante */
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.22);
    }
    .cast-zoom-body img{
      max-width:100%;
      max-height:70vh;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      object-fit:contain;
      background: rgba(0,0,0,.15);
    }
    .cast-zoom-info{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .cast-zoom-name{ font-weight:900; }
    .cast-zoom-role{ opacity:.85; font-size:13px; }
    .cast-zoom-link{
      font-weight:900;
      text-decoration:none;
      color:var(--accent);
      font-size:13px;
    }
    .cast-zoom-link:hover{ text-decoration:underline; }

    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 980px){
      .split{ grid-template-columns: 1fr 1fr; }
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
      margin-top:8px;
    }
    code.k{
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: var(--text);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Sistema de Filmes e S√©ries ‚Äî Elenco clic√°vel (cast_data) ‚úÖ</h1>
        <p class="sub">
          Aqui j√° est√° <b>integrado de verdade</b>: carrega do Supabase, lista as m√≠dias e, ao abrir uma m√≠dia, renderiza o elenco em miniaturas clic√°veis
          com zoom (modal com rolagem).
        </p>
      </div>
    </header>

    <div class="row">
      <!-- CONFIG SUPABASE -->
      <div class="card">
        <div class="head">
          <div class="badge"><b>1) Configura√ß√£o</b> ‚Ä¢ Supabase</div>
          <div class="pill"><span class="dot" id="connDot"></span><span id="connTxt">Desconectado</span></div>
        </div>
        <div class="content">
          <div class="split">
            <div class="field">
              <label>SUPABASE URL</label>
              <input id="sbUrl" placeholder="https://xxxx.supabase.co" />
            </div>
            <div class="field">
              <label>SUPABASE ANON KEY</label>
              <input id="sbKey" placeholder="eyJhbGciOi..." />
            </div>
          </div>

          <div class="split">
            <div class="field">
              <label>Tabela</label>
              <input id="sbTable" value="midias" />
            </div>
            <div class="field">
              <label>Order</label>
              <input id="sbOrder" value="created_at.desc" />
            </div>
          </div>

          <div class="actions">
            <button class="btn-primary" id="btnConnect">Conectar e carregar m√≠dias</button>
            <button id="btnSaveConfig">Salvar config (local)</button>
            <button class="btn-danger" id="btnClearConfig">Limpar config</button>
          </div>

          <div class="hint">
            ‚Ä¢ A tabela precisa ter pelo menos: <code class="k">id</code>, <code class="k">titulo</code> (ou <code class="k">nome</code>), e <code class="k">cast_data</code> (jsonb ou texto JSON).<br>
            ‚Ä¢ Se seu campo se chama diferente, ajuste em <code class="k">FIELD_MAP</code> no JS.
          </div>
        </div>
      </div>

      <!-- LISTA DE M√çDIAS -->
      <div class="card">
        <div class="head">
          <div class="badge"><b>2) M√≠dias</b> ‚Ä¢ clique para abrir</div>
          <div class="badge"><span id="midiasCount">0</span> itens</div>
        </div>
        <div class="content">
          <div class="field">
            <label>Buscar</label>
            <input id="search" placeholder="Digite para filtrar pelo t√≠tulo..." />
          </div>
          <div id="midiasList" class="list"></div>
          <div id="midiasEmpty" class="muted" style="display:none; margin-top:10px;">
            Nenhuma m√≠dia carregada.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL M√çDIA (detalhes) -->
  <div class="modal" id="midiaModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="Detalhes da m√≠dia">
      <div class="modal-head">
        <div class="modal-title">
          <h2 id="mTitle">M√≠dia</h2>
          <p id="mMeta">‚Äî</p>
        </div>
        <div class="close" id="mClose" title="Fechar (ESC)">√ó</div>
      </div>

      <div class="modal-body">
        <div class="box">
          <div class="box-head">
            <h3>Dados</h3>
            <span class="muted" id="mId">ID: ‚Äî</span>
          </div>
          <div class="field">
            <label>T√≠tulo</label>
            <input id="mTitulo" disabled />
          </div>
          <div class="field">
            <label>Tipo</label>
            <input id="mTipo" disabled />
          </div>
          <div class="field">
            <label>Sinopse (se existir)</label>
            <textarea id="mSinopse" disabled></textarea>
          </div>
          <div class="hint">
            Este HTML √© focado no <b>cast_data</b>. Voc√™ pode reaproveitar e encaixar no seu layout maior sem ‚Äúprocurar‚Äù.
          </div>
        </div>

        <!-- ‚úÖ ELENCO (cast_data) -->
        <section class="box">
          <div class="box-head">
            <h3>Elenco</h3>
            <span class="muted" id="castCount">0</span>
          </div>

          <div id="castGrid" class="cast-grid"></div>

          <div id="castEmpty" class="muted" style="display:none; margin-top:8px;">
            Sem elenco cadastrado.
          </div>

          <div class="hint">
            Clique numa foto para ampliar. Se vier TMDB em <code class="k">/w185</code>, o zoom tenta trocar para <code class="k">/original</code>.
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- ‚úÖ MODAL ZOOM (foto do cast) -->
  <div class="cast-zoom-modal" id="castZoomModal" aria-hidden="true">
    <div class="cast-zoom-card" role="dialog" aria-modal="true" aria-label="Foto do elenco">
      <button class="cast-zoom-close" id="castZoomClose" title="Fechar (ESC)">√ó</button>

      <div class="cast-zoom-body">
        <img id="castZoomImg" alt="Foto do elenco" />
      </div>

      <div class="cast-zoom-info">
        <div class="cast-zoom-name" id="castZoomName">Nome</div>
        <div class="cast-zoom-role" id="castZoomRole">Personagem</div>
        <a class="cast-zoom-link" id="castZoomLink" href="#" target="_blank" rel="noopener">Abrir imagem</a>
      </div>
    </div>
  </div>

  <script>
    // ==========================================================
    // CONFIG
    // ==========================================================
    const CONFIG_KEY = "midias_app_supabase_config_v1";

    // Ajuste aqui se seus campos t√™m nomes diferentes
    const FIELD_MAP = {
      id: "id",
      title: ["titulo","title","nome","name"],
      type: ["tipo","type"],
      overview: ["sinopse","overview","descricao","description"],
      cast: ["cast_data","cast","elenco","castdata"]
    };

    // ==========================================================
    // DOM
    // ==========================================================
    const $ = (sel) => document.querySelector(sel);

    const sbUrl = $("#sbUrl");
    const sbKey = $("#sbKey");
    const sbTable = $("#sbTable");
    const sbOrder = $("#sbOrder");

    const btnConnect = $("#btnConnect");
    const btnSaveConfig = $("#btnSaveConfig");
    const btnClearConfig = $("#btnClearConfig");

    const connDot = $("#connDot");
    const connTxt = $("#connTxt");

    const search = $("#search");
    const midiasList = $("#midiasList");
    const midiasEmpty = $("#midiasEmpty");
    const midiasCount = $("#midiasCount");

    // Modal m√≠dia
    const midiaModal = $("#midiaModal");
    const mClose = $("#mClose");
    const mTitle = $("#mTitle");
    const mMeta = $("#mMeta");
    const mId = $("#mId");
    const mTitulo = $("#mTitulo");
    const mTipo = $("#mTipo");
    const mSinopse = $("#mSinopse");

    // Elenco no modal m√≠dia
    const castGrid = $("#castGrid");
    const castCount = $("#castCount");
    const castEmpty = $("#castEmpty");

    // Modal zoom
    const castZoomModal = $("#castZoomModal");
    const castZoomClose = $("#castZoomClose");
    const castZoomImg = $("#castZoomImg");
    const castZoomName = $("#castZoomName");
    const castZoomRole = $("#castZoomRole");
    const castZoomLink = $("#castZoomLink");

    // ==========================================================
    // STATE
    // ==========================================================
    let supabaseClient = null;
    let allMidias = [];

    // ==========================================================
    // HELPERS
    // ==========================================================
    function setConnStatus(type, text){
      connDot.className = "dot";
      if(type === "ok") connDot.classList.add("ok");
      if(type === "err") connDot.classList.add("err");
      connTxt.textContent = text;
    }

    function safeStr(v){ return (v === null || v === undefined) ? "" : String(v); }

    function pickField(obj, candidates){
      if(!obj) return "";
      if(typeof candidates === "string") return obj[candidates];
      for(const k of candidates){
        if(obj[k] !== undefined && obj[k] !== null) return obj[k];
      }
      return "";
    }

    function escapeHtml(str){
      return safeStr(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function makeFallbackAvatar(name){
      const initials = (safeStr(name).trim().split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||"").join("") || "üë§");
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="360" height="480">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#20263a"/>
              <stop offset="1" stop-color="#121628"/>
            </linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#g)"/>
          <circle cx="180" cy="185" r="78" fill="rgba(255,255,255,.08)"/>
          <rect x="78" y="285" width="204" height="120" rx="60" fill="rgba(255,255,255,.07)"/>
          <text x="50%" y="56%" font-family="system-ui,Segoe UI,Roboto,Arial" font-size="64" fill="rgba(255,255,255,.85)" text-anchor="middle">${escapeHtml(initials)}</text>
        </svg>
      `;
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    }

    function buildImgUrl(url){
      if(!url) return "";
      if(/^https?:\/\//i.test(url)) return url;

      // TMDB path tipo "/abc.jpg"
      if(url.startsWith("/")) return "https://image.tmdb.org/t/p/w185" + url;

      return url;
    }

    function toOriginalIfPossible(url){
      if(!url) return url;
      const m = url.match(/\/t\/p\/(w\d+|h\d+|original)\//);
      if(m) return url.replace(/\/t\/p\/(w\d+|h\d+|original)\//, "/t/p/original/");
      return url.replace("w185", "original").replace("w92", "original").replace("w154", "original");
    }

    function normalizeCastItem(item){
      return {
        id: item?.id ?? item?.cast_id ?? item?.person_id ?? null,
        nome: item?.nome ?? item?.name ?? "",
        personagem: item?.personagem ?? item?.character ?? item?.role ?? "",
        foto: item?.foto ?? item?.profile_path ?? item?.photo ?? "",
        _raw: item
      };
    }

    // ==========================================================
    // SUPABASE (REST) - sem libs externas
    // ==========================================================
    async function sbFetch(path, { method="GET", body=null } = {}){
      const base = sbUrl.value.trim().replace(/\/+$/,"");
      const key = sbKey.value.trim();
      if(!base || !key) throw new Error("Supabase URL/Key n√£o informados.");

      const url = base + "/rest/v1/" + path;
      const headers = {
        "apikey": key,
        "Authorization": "Bearer " + key,
        "Content-Type": "application/json",
        "Accept": "application/json"
      };

      const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : null });
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`Erro Supabase (${res.status}): ${txt || res.statusText}`);
      }
      return res.json();
    }

    async function loadMidias(){
      const table = sbTable.value.trim() || "midias";
      const order = (sbOrder.value.trim() || "created_at.desc");
      const select = "*";

      // order=created_at.desc
      const path = `${encodeURIComponent(table)}?select=${encodeURIComponent(select)}&order=${encodeURIComponent(order)}`;
      const data = await sbFetch(path);
      allMidias = Array.isArray(data) ? data : [];
      renderMidias();
      setConnStatus("ok", "Conectado");
    }

    // ==========================================================
    // LISTA
    // ==========================================================
    function renderMidias(){
      midiasList.innerHTML = "";
      const q = safeStr(search.value).trim().toLowerCase();

      const filtered = allMidias.filter(m => {
        const title = safeStr(pickField(m, FIELD_MAP.title)).toLowerCase();
        return !q || title.includes(q);
      });

      midiasCount.textContent = String(filtered.length);
      midiasEmpty.style.display = filtered.length ? "none" : "block";

      filtered.forEach(midia => {
        const title = pickField(midia, FIELD_MAP.title) || "(Sem t√≠tulo)";
        const type = pickField(midia, FIELD_MAP.type) || "‚Äî";
        const id = pickField(midia, FIELD_MAP.id);

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <p class="title">${escapeHtml(title)}</p>
            <p class="meta">Tipo: ${escapeHtml(type)} ‚Ä¢ ID: ${escapeHtml(id)}</p>
          </div>
          <span class="tag">Abrir</span>
        `;
        el.addEventListener("click", () => openMidiaModal(midia));
        midiasList.appendChild(el);
      });
    }

    // ==========================================================
    // MODAL M√çDIA + ELENCO (INTEGRA√á√ÉO REAL)
    // ==========================================================
    function openMidiaModal(midia){
      const title = pickField(midia, FIELD_MAP.title) || "(Sem t√≠tulo)";
      const type = pickField(midia, FIELD_MAP.type) || "‚Äî";
      const overview = pickField(midia, FIELD_MAP.overview) || "";
      const id = pickField(midia, FIELD_MAP.id);

      mTitle.textContent = title;
      mMeta.textContent = `Tipo: ${type}`;
      mId.textContent = `ID: ${id}`;

      mTitulo.value = title;
      mTipo.value = type;
      mSinopse.value = overview;

      renderCastFromMidia(midia); // ‚úÖ aqui √© a integra√ß√£o real

      midiaModal.classList.add("show");
      midiaModal.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }

    function closeMidiaModal(){
      midiaModal.classList.remove("show");
      midiaModal.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }

    mClose.addEventListener("click", closeMidiaModal);
    midiaModal.addEventListener("click", (e) => { if(e.target === midiaModal) closeMidiaModal(); });

    function renderCastFromMidia(midia){
      castGrid.innerHTML = "";
      castCount.textContent = "0";
      castEmpty.style.display = "none";

      // pega o campo cast_data (ou equivalente)
      let cast = pickField(midia, FIELD_MAP.cast);

      // pode vir jsonb (array/obj) ou string JSON
      if(typeof cast === "string"){
        cast = cast.trim();
        if(cast){
          try { cast = JSON.parse(cast); } catch(e){ cast = null; }
        }
      }

      if(!Array.isArray(cast) || cast.length === 0){
        castEmpty.style.display = "block";
        return;
      }

      const normalized = cast.map(normalizeCastItem);

      normalized.forEach(actor => {
        const card = document.createElement("div");
        card.className = "cast-card";
        card.tabIndex = 0;

        const thumb = buildImgUrl(actor.foto);
        const fallback = makeFallbackAvatar(actor.nome);

        card.innerHTML = `
          <div class="cast-photo">
            <img src="${escapeHtml(thumb || fallback)}" alt="${escapeHtml(actor.nome)}" loading="lazy"
                 onerror="this.onerror=null; this.src='${escapeHtml(fallback)}';" />
          </div>
          <p class="cast-name" title="${escapeHtml(actor.nome)}">${escapeHtml(actor.nome || "Sem nome")}</p>
          <p class="cast-role" title="${escapeHtml(actor.personagem)}">${escapeHtml(actor.personagem || "")}</p>
        `;

        const open = () => openCastZoom(actor);
        card.addEventListener("click", open);
        card.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){ e.preventDefault(); open(); }
        });

        castGrid.appendChild(card);
      });

      castCount.textContent = String(normalized.length);
    }

    // ==========================================================
    // MODAL ZOOM CAST
    // ==========================================================
    function openCastZoom(actor){
      const thumb = buildImgUrl(actor?.foto);
      const big = toOriginalIfPossible(thumb);
      const fallback = makeFallbackAvatar(actor?.nome);

      castZoomName.textContent = actor?.nome || "Sem nome";
      castZoomRole.textContent = actor?.personagem || "‚Äî";

      const finalUrl = big || thumb || "";
      castZoomImg.src = finalUrl || fallback;
      castZoomImg.onerror = () => { castZoomImg.onerror = null; castZoomImg.src = fallback; };

      castZoomLink.href = finalUrl || "#";
      castZoomLink.textContent = finalUrl ? "Abrir imagem" : "Sem URL";
      castZoomLink.style.pointerEvents = finalUrl ? "auto" : "none";
      castZoomLink.style.opacity = finalUrl ? "1" : ".6";

      castZoomModal.classList.add("show");
      castZoomModal.setAttribute("aria-hidden","false");
    }

    function closeCastZoom(){
      castZoomModal.classList.remove("show");
      castZoomModal.setAttribute("aria-hidden","true");
    }

    castZoomClose.addEventListener("click", closeCastZoom);
    castZoomModal.addEventListener("click", (e) => { if(e.target === castZoomModal) closeCastZoom(); });

    // ==========================================================
    // EVENTS
    // ==========================================================
    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        if(castZoomModal.classList.contains("show")) closeCastZoom();
        else if(midiaModal.classList.contains("show")) closeMidiaModal();
      }
    });

    search.addEventListener("input", renderMidias);

    btnConnect.addEventListener("click", async () => {
      try{
        setConnStatus("", "Conectando...");
        await loadMidias();
      }catch(err){
        console.error(err);
        setConnStatus("err", "Falha ao conectar");
        midiasList.innerHTML = "";
        midiasCount.textContent = "0";
        midiasEmpty.style.display = "block";
        midiasEmpty.textContent = safeStr(err.message || err);
      }
    });

    btnSaveConfig.addEventListener("click", () => {
      const cfg = {
        url: sbUrl.value.trim(),
        key: sbKey.value.trim(),
        table: sbTable.value.trim(),
        order: sbOrder.value.trim()
      };
      localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
      setConnStatus("ok", "Config salva");
      setTimeout(()=> setConnStatus("", "Desconectado"), 1000);
    });

    btnClearConfig.addEventListener("click", () => {
      localStorage.removeItem(CONFIG_KEY);
      sbUrl.value = "";
      sbKey.value = "";
      sbTable.value = "midias";
      sbOrder.value = "created_at.desc";
      setConnStatus("", "Desconectado");
    });

    // ==========================================================
    // BOOT
    // ==========================================================
    (function boot(){
      try{
        const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY) || "null");
        if(cfg){
          sbUrl.value = cfg.url || "";
          sbKey.value = cfg.key || "";
          sbTable.value = cfg.table || "midias";
          sbOrder.value = cfg.order || "created_at.desc";
        }
      }catch(_){}

      setConnStatus("", "Desconectado");
      midiasEmpty.style.display = "block";
    })();
  </script>
</body>
</html>
