<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Minha Cole√ß√£o</title>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#f6f7fb;
      --card:#ffffff;
      --bd:#e5e7eb;
      --txt:#0f172a;
      --mut:#64748b;
      --pri:#4f46e5;
      --pri2:#eef2ff;
      --ok:#16a34a;
      --warn:#b45309;
      --danger:#b91c1c;
      --shadow: 0 10px 30px rgba(15,23,42,.10);
      --r:16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:var(--bg);color:var(--txt)}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 14px 44px}
    header{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start;margin-bottom:12px}
    h1{margin:0;font-size:1.55rem}
    .sub{margin:6px 0 0;color:var(--mut);font-size:.92rem}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .panel{background:var(--panel);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin:12px 0}
    .btn{border:0;border-radius:999px;padding:8px 14px;cursor:pointer;transition:.15s;white-space:nowrap;font-weight:600}
    .btn.primary{background:var(--pri);color:#fff;box-shadow:0 6px 18px rgba(79,70,229,.25)}
    .btn.primary:hover{background:#4338ca;transform:translateY(-1px)}
    .btn.secondary{background:var(--pri2);color:var(--pri)}
    .btn.ghost{background:transparent;border:1px solid var(--bd);color:var(--mut)}
    .btn.danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .btn.small{padding:6px 10px;font-size:.82rem}

    input,select,textarea{
      width:100%;padding:9px 10px;border-radius:12px;border:1px solid var(--bd);
      background:#fff;font-size:.93rem;outline:none
    }
    textarea{resize:vertical}
    label{font-size:.78rem;color:var(--mut);font-weight:700}
    .small{font-size:.83rem;color:var(--mut)}
    .divider{height:1px;background:var(--bd);margin:10px 0}

    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}

    /* Cards */
    .card{
      background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);
      padding:10px;display:flex;gap:10px;cursor:pointer;min-height:128px
    }
    .card:hover{outline:2px solid rgba(79,70,229,.15)}
    .poster{width:84px;flex:0 0 84px;border-radius:14px;overflow:hidden;background:#e5e7eb}
    .poster img{width:100%;height:116px;object-fit:cover;display:block}
    .content{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px}
    .titleLine{display:flex;gap:8px;align-items:flex-start}
    .title{
      font-weight:800;font-size:.98rem;min-width:0;flex:1;line-height:1.15;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
      word-break:break-word;
    }
    .badge{font-size:.7rem;padding:2px 8px;border-radius:999px;background:#e5e7eb;flex:0 0 auto}
    .meta{
      color:var(--mut);font-size:.82rem;display:flex;flex-wrap:wrap;gap:6px;
      min-height:18px
    }
    .footer{
      margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap
    }
    .status{font-size:.74rem;border-radius:999px;padding:3px 9px;font-weight:700}
    .st-assistindo{background:#eef2ff;color:#4f46e5}
    .st-assistidos{background:#dcfce7;color:#15803d}
    .st-nao{background:#fef3c7;color:#92400e}
    .starsInline{font-size:.86rem;color:#0f172a;white-space:nowrap;display:flex;gap:6px;align-items:center}
    .starsInline .mut{color:var(--mut);font-weight:700}

    /* Modal */
    .backdrop{
      position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50
    }
    .backdrop.show{display:flex}
    .modal{
      width:min(980px, 100%);background:#fff;border-radius:20px;box-shadow:0 24px 70px rgba(0,0,0,.35);
      overflow:hidden
    }
    .modalHeader{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      padding:14px 14px 10px;background:linear-gradient(180deg, #ffffff, #fafafa);
      border-bottom:1px solid var(--bd)
    }
    .modalTitle{margin:0;font-size:1.1rem}
    .modalBody{padding:14px}
    .modalFooter{
      padding:12px 14px;border-top:1px solid var(--bd);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap
    }

    .layout2{display:grid;grid-template-columns: 180px 1fr;gap:12px}
    @media(max-width:820px){.layout2{grid-template-columns:1fr}}
    .bigPoster{
      width:180px;height:260px;border-radius:16px;overflow:hidden;background:#e5e7eb
    }
    @media(max-width:820px){.bigPoster{width:100%;height:240px}}
    .bigPoster img{width:100%;height:100%;object-fit:cover;display:block}

    .formGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px 12px}
    .full{grid-column:1/-1}

    /* Rating */
    .ratingRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .stars{
      user-select:none;cursor:pointer;font-size:1.35rem;letter-spacing:1px;
      padding:4px 10px;border-radius:14px;border:1px dashed var(--bd);background:#fff
    }
    .stars.readonly{cursor:default;opacity:.95}
    .pill{
      background:var(--panel);border:1px solid var(--bd);border-radius:999px;padding:6px 10px;font-size:.82rem;color:var(--mut);font-weight:700
    }

    /* Episodes */
    details{border:1px solid var(--bd);border-radius:14px;background:#fff;box-shadow:0 10px 22px rgba(15,23,42,.06)}
    details + details{margin-top:10px}
    summary{cursor:pointer;padding:10px 12px;list-style:none;font-weight:800}
    summary::-webkit-details-marker{display:none}
    .epWrap{padding:10px 12px;border-top:1px solid var(--bd)}
    .epGroupTitle{font-weight:900;margin:0 0 8px}
    .epTable{width:100%;border-collapse:collapse;font-size:.86rem}
    .epTable th,.epTable td{padding:8px;border-bottom:1px solid var(--bd);text-align:left;vertical-align:top}
    .epTable th{background:#f3f4f6}
    .epActions{display:flex;gap:6px;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:6px}

    /* Toast */
    .toast{
      position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;
      padding:10px 14px;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.25);
      opacity:0;transform:translateY(12px);transition:.2s;pointer-events:none;z-index:60
    }
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.err{background:#b91c1c}
    .toast.ok{background:#065f46}

    a.link{color:var(--pri);text-decoration:none;font-weight:700}
    a.link:hover{text-decoration:underline}
    .linksList{display:flex;flex-direction:column;gap:6px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üé¨ Minha Cole√ß√£o</h1>
        <p class="sub">Clique em qualquer card para ver detalhes. S√©rie mostra o guia de epis√≥dios dentro do modal.</p>
      </div>
      <div class="row">
        <button class="btn secondary" id="btnRecarregar">Recarregar</button>
        <button class="btn primary" id="btnNovo">+ Nova m√≠dia</button>
      </div>
    </header>

    <section class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <select id="fStatus" style="min-width:180px">
            <option value="">Todos status</option>
            <option value="ASSISTINDO">Assistindo</option>
            <option value="ASSISTIDOS">Assistidos</option>
            <option value="AINDA_NAO_COMECEI">Ainda n√£o comecei</option>
          </select>

          <select id="fTipo" style="min-width:150px">
            <option value="">Filmes + S√©ries</option>
            <option value="FILME">S√≥ Filmes</option>
            <option value="SERIE">S√≥ S√©ries</option>
          </select>

          <input id="fNome" placeholder="Buscar por nome..." style="min-width:240px" />
          <input id="fNota" placeholder="Nota m√≠nima (ex: 0,5 ou 3.5)" style="max-width:210px" />
        </div>

        <div class="small" id="countInfo"></div>
      </div>
    </section>

    <section id="lista" class="grid"></section>
  </div>

  <!-- MODAL DETALHES/EDITAR -->
  <div class="backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div style="min-width:0">
          <h2 class="modalTitle" id="modalTitle">Detalhes</h2>
          <div class="small" id="modalSub"></div>
        </div>
        <div class="row">
          <button class="btn ghost small" id="btnFechar">Fechar</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="layout2">
          <div>
            <div class="bigPoster">
              <img id="mPoster" alt="poster" />
            </div>
            <div style="margin-top:10px" class="row">
              <span class="pill" id="mBadgeTipo">-</span>
              <span class="pill" id="mBadgeStatus">-</span>
            </div>
            <div style="margin-top:10px" class="small" id="mStarsText"></div>
          </div>

          <div style="min-width:0">
            <form id="formMidia" class="formGrid">
              <input type="hidden" id="mId" />

              <div class="full">
                <label>Nome</label>
                <input id="mNome" required />
              </div>

              <div>
                <label>Tipo</label>
                <select id="mTipo" required>
                  <option value="FILME">Filme</option>
                  <option value="SERIE">S√©rie</option>
                </select>
              </div>

              <div>
                <label>Status</label>
                <select id="mStatus">
                  <option value="ASSISTINDO">Assistindo</option>
                  <option value="ASSISTIDOS">Assistidos</option>
                  <option value="AINDA_NAO_COMECEI">Ainda n√£o comecei</option>
                </select>
              </div>

              <div>
                <label>Streaming</label>
                <input id="mStreaming" placeholder="Netflix, Prime..." />
              </div>

              <div>
                <label>Ano</label>
                <input id="mAno" type="number" min="1900" max="2100" />
              </div>

              <div class="full">
                <label>URL do p√¥ster</label>
                <input id="mImagemUrl" placeholder="https://...jpg" />
              </div>

              <div class="full">
                <label>Links (onde encontrar) ‚Äî 1 por linha</label>
                <textarea id="mLinks" rows="3" placeholder="https://...\nhttps://..."></textarea>
                <div class="small">No modo Detalhes, esses links ficam clic√°veis.</div>
              </div>

              <div class="full">
                <label>Avalia√ß√£o (0 a 5, com meia estrela)</label>
                <div class="ratingRow">
                  <div class="stars" id="starsMidia" title="Clique para definir (meia estrela tamb√©m)">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                  <input id="mAvaliacao" placeholder="Ex: 0,5 ou 4.5" inputmode="decimal" style="max-width:220px" />
                  <span class="small">Aceita v√≠rgula ou ponto</span>
                </div>
              </div>

              <div class="full">
                <label>Sinopse</label>
                <textarea id="mSinopse" rows="3" placeholder="Opcional"></textarea>
              </div>

              <!-- LINKS VISUALIZA√á√ÉO (s√≥ no modo detalhes) -->
              <div class="full" id="linksViewBox" style="display:none">
                <label>Links cadastrados</label>
                <div class="linksList" id="linksView"></div>
              </div>
            </form>
          </div>
        </div>

        <!-- EPIS√ìDIOS (s√≥ pra s√©rie) -->
        <div id="epsSection" style="display:none;margin-top:14px">
          <div class="divider"></div>
          <div class="row" style="justify-content:space-between;align-items:flex-end">
            <div>
              <h3 style="margin:0;font-size:1.02rem">Guia de Epis√≥dios</h3>
              <div class="small">Agrupado por temporada e por status.</div>
            </div>
            <div class="row">
              <button class="btn secondary small" id="btnNovoEp">+ Epis√≥dio</button>
            </div>
          </div>

          <div id="epFormBox" class="panel" style="display:none;margin-top:10px">
            <div class="row" style="justify-content:space-between">
              <div style="font-weight:900">Cadastrar/Editar epis√≥dio</div>
              <button class="btn ghost small" id="btnCancelarEp" type="button">Fechar</button>
            </div>
            <div class="divider"></div>

            <form id="formEp" class="formGrid">
              <input type="hidden" id="epId" />

              <div>
                <label>Temporada</label>
                <input id="epTemp" type="number" min="1" required />
              </div>

              <div>
                <label>N¬∫ epis√≥dio</label>
                <input id="epNum" type="number" min="1" required />
              </div>

              <div class="full">
                <label>T√≠tulo</label>
                <input id="epTitulo" placeholder="Opcional" />
              </div>

              <div class="full">
                <label>Resumo</label>
                <textarea id="epResumo" rows="3" placeholder="Resumo do epis√≥dio"></textarea>
              </div>

              <div>
                <label>Status</label>
                <select id="epStatus">
                  <option value="AINDA_NAO_COMECEI">Ainda n√£o comecei</option>
                  <option value="ASSISTINDO">Assistindo</option>
                  <option value="ASSISTIDOS">Assistidos</option>
                </select>
              </div>

              <div class="full">
                <label>Avalia√ß√£o do epis√≥dio (0 a 5, meia estrela)</label>
                <div class="ratingRow">
                  <div class="stars" id="starsEp">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                  <input id="epAvaliacao" placeholder="Ex: 0,5 ou 3.5" inputmode="decimal" style="max-width:220px" />
                </div>
              </div>

              <div class="row full">
                <button class="btn primary" type="submit">Salvar epis√≥dio</button>
              </div>
            </form>
          </div>

          <div id="epsGrouped" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="modalFooter">
        <div class="row">
          <button class="btn danger" id="btnExcluir">Excluir</button>
        </div>
        <div class="row">
          <button class="btn ghost" id="btnEditar">Editar</button>
          <button class="btn primary" id="btnSalvar">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ======= CONFIGURE AQUI O SEU SUPABASE =======
    const SUPABASE_URL = "https://koytoiwfvwzjvgcqhlal.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtveXRvaXdmdnd6anZnY3FobGFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDExNzAsImV4cCI6MjA3OTcxNzE3MH0.mrMRUGJFqzOBjj7M4giHcWr5qsqUn_0woVMFikDxrjM";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========= Toast =========
    const toast = document.getElementById("toast");
    function msg(text, type="ok"){
      toast.className = "toast " + (type==="err"?"err":"ok");
      toast.textContent = text;
      toast.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>toast.classList.remove("show"), 2200);
    }

    // ========= Rating (fix 0,5) =========
    function sanitizeRating(value){
      if (value === null || value === undefined) return null;
      let s = String(value).trim();
      if (!s) return null;

      // aceita v√≠rgula
      s = s.replace(",", ".");

      let n = Number(s);
      if (!Number.isFinite(n)) return null;

      n = Math.max(0, Math.min(5, n));
      n = Math.round(n * 2) / 2; // 0.5 steps
      return n;
    }

    function starsString(r){
      const n = sanitizeRating(r);
      if (n === null) return "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
      const full = Math.floor(n);
      const half = (n - full) >= 0.5 ? 1 : 0;
      const empty = Math.max(0, 5 - full - half);
      return "‚òÖ".repeat(full) + (half ? "‚Ø®" : "") + "‚òÜ".repeat(empty);
    }

    function bindStars(starsEl, inputEl){
      function sync(){
        starsEl.textContent = starsString(inputEl.value);
      }
      starsEl.addEventListener("click", (ev)=>{
        const rect = starsEl.getBoundingClientRect();
        const x = ev.clientX - rect.left;
        const ratio = Math.max(0, Math.min(1, x / rect.width));
        let rating = Math.round(ratio * 10) / 2; // 0..5 step 0.5
        rating = Math.max(0, Math.min(5, rating));
        inputEl.value = String(rating).replace(".0","").replace(".", ","); // exibe com v√≠rgula
        sync();
      });
      inputEl.addEventListener("input", sync);
      sync();
    }

    function statusLabel(s){
      if(s==="ASSISTINDO") return "Assistindo";
      if(s==="ASSISTIDOS") return "Assistidos";
      return "Ainda n√£o comecei";
    }
    function statusClass(s){
      if(s==="ASSISTINDO") return "st-assistindo";
      if(s==="ASSISTIDOS") return "st-assistidos";
      return "st-nao";
    }

    function safePoster(url){
      return url && String(url).trim()
        ? url.trim()
        : "https://via.placeholder.com/300x450.png?text=Sem+Imagem";
    }

    // ========= State =========
    let midias = [];
    let current = null;
    let modalMode = "view"; // view | edit | create
    let eps = [];

    // ========= Filters =========
    const fStatus = document.getElementById("fStatus");
    const fTipo = document.getElementById("fTipo");
    const fNome = document.getElementById("fNome");
    const fNota = document.getElementById("fNota");
    const countInfo = document.getElementById("countInfo");
    const lista = document.getElementById("lista");

    // ========= Modal refs =========
    const modalBackdrop = document.getElementById("modalBackdrop");
    const btnFechar = document.getElementById("btnFechar");
    const btnEditar = document.getElementById("btnEditar");
    const btnSalvar = document.getElementById("btnSalvar");
    const btnExcluir = document.getElementById("btnExcluir");

    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");
    const mPoster = document.getElementById("mPoster");
    const mBadgeTipo = document.getElementById("mBadgeTipo");
    const mBadgeStatus = document.getElementById("mBadgeStatus");
    const mStarsText = document.getElementById("mStarsText");

    const mId = document.getElementById("mId");
    const mNome = document.getElementById("mNome");
    const mTipo = document.getElementById("mTipo");
    const mStatus = document.getElementById("mStatus");
    const mStreaming = document.getElementById("mStreaming");
    const mAno = document.getElementById("mAno");
    const mImagemUrl = document.getElementById("mImagemUrl");
    const mLinks = document.getElementById("mLinks");
    const mAvaliacao = document.getElementById("mAvaliacao");
    const mSinopse = document.getElementById("mSinopse");

    const starsMidia = document.getElementById("starsMidia");
    bindStars(starsMidia, mAvaliacao);

    const linksViewBox = document.getElementById("linksViewBox");
    const linksView = document.getElementById("linksView");

    // ========= Episodes UI =========
    const epsSection = document.getElementById("epsSection");
    const btnNovoEp = document.getElementById("btnNovoEp");
    const epFormBox = document.getElementById("epFormBox");
    const btnCancelarEp = document.getElementById("btnCancelarEp");
    const formEp = document.getElementById("formEp");
    const epId = document.getElementById("epId");
    const epTemp = document.getElementById("epTemp");
    const epNum = document.getElementById("epNum");
    const epTitulo = document.getElementById("epTitulo");
    const epResumo = document.getElementById("epResumo");
    const epStatus = document.getElementById("epStatus");
    const epAvaliacao = document.getElementById("epAvaliacao");
    const starsEp = document.getElementById("starsEp");
    bindStars(starsEp, epAvaliacao);

    const epsGrouped = document.getElementById("epsGrouped");

    // ========= Buttons =========
    document.getElementById("btnNovo").onclick = ()=>openModalCreate();
    document.getElementById("btnRecarregar").onclick = ()=>loadMidias(true);

    // ========= Supabase: load =========
    async function loadMidias(showToast=false){
      const { data, error } = await db.from("midias").select("*").order("id",{ascending:false});
      if(error){
        console.error(error);
        msg("Erro ao carregar m√≠dias", "err");
        return;
      }
      midias = data || [];
      renderList();
      if(showToast) msg("Atualizado ‚úÖ","ok");
    }

    async function loadEps(midiaId){
      const { data, error } = await db.from("episodios")
        .select("*")
        .eq("midia_id", midiaId)
        .order("temporada",{ascending:true})
        .order("numero",{ascending:true});

      if(error){
        console.error(error);
        msg("Erro ao carregar epis√≥dios","err");
        eps = [];
        renderEpisodes();
        return;
      }
      eps = data || [];
      renderEpisodes();
    }

    // ========= Render list =========
    function getFiltered(){
      let arr = [...midias];
      const st = fStatus.value;
      const tp = fTipo.value;
      const q = fNome.value.trim().toLowerCase();
      const minNota = sanitizeRating(fNota.value);

      if(st) arr = arr.filter(m=>m.status===st);
      if(tp) arr = arr.filter(m=>m.tipo===tp);
      if(q) arr = arr.filter(m=>(m.nome||"").toLowerCase().includes(q));
      if(minNota !== null){
        arr = arr.filter(m=>{
          const n = sanitizeRating(m.avaliacao);
          return n !== null && n >= minNota;
        });
      }
      return arr;
    }

    function renderList(){
      const arr = getFiltered();
      countInfo.textContent = `${arr.length} item(ns)`;
      lista.innerHTML = "";

      if(!arr.length){
        lista.innerHTML = `<div class="panel"><span class="small">Nada encontrado com os filtros.</span></div>`;
        return;
      }

      for(const m of arr){
        const card = document.createElement("div");
        card.className = "card";
        card.title = "Clique para ver detalhes";
        card.onclick = ()=>openModalView(m);

        const poster = document.createElement("div");
        poster.className = "poster";
        poster.innerHTML = `<img src="${safePoster(m.imagem_url)}" alt="">`;

        const content = document.createElement("div");
        content.className = "content";

        const tl = document.createElement("div");
        tl.className = "titleLine";
        tl.innerHTML = `
          <div class="title">${escapeHtml(m.nome || "(sem nome)")}</div>
          <span class="badge">${m.tipo==="SERIE"?"S√©rie":"Filme"}</span>
        `;

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = [m.ano, m.streaming, m.diretores, m.genero].filter(Boolean).join(" ‚Ä¢ ");

        const footer = document.createElement("div");
        footer.className = "footer";

        const st = document.createElement("span");
        st.className = `status ${statusClass(m.status)}`;
        st.textContent = statusLabel(m.status);

        const stars = document.createElement("div");
        stars.className = "starsInline";
        const n = sanitizeRating(m.avaliacao);
        stars.innerHTML = `<span class="mut">${n===null? "-" : n.toFixed(1).replace(".0","")}</span> <span>${starsString(m.avaliacao)}</span>`;

        footer.appendChild(st);
        footer.appendChild(stars);

        content.appendChild(tl);
        content.appendChild(meta);
        content.appendChild(footer);

        card.appendChild(poster);
        card.appendChild(content);

        lista.appendChild(card);
      }
    }

    // ========= Modal helpers =========
    function setInputsEnabled(enabled){
      const fields = [mNome,mTipo,mStatus,mStreaming,mAno,mImagemUrl,mLinks,mAvaliacao,mSinopse];
      fields.forEach(el=> el.disabled = !enabled);
      starsMidia.classList.toggle("readonly", !enabled);
      starsMidia.style.pointerEvents = enabled ? "auto" : "none";
      btnSalvar.style.display = enabled ? "inline-flex" : "none";
    }

    function fillLinksView(raw){
      const text = (raw || "").trim();
      linksView.innerHTML = "";
      if(!text){
        linksViewBox.style.display = "none";
        return;
      }
      linksViewBox.style.display = "block";
      const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);
      for(const u of lines){
        const a = document.createElement("a");
        a.className = "link";
        a.href = normalizeUrl(u);
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = u;
        linksView.appendChild(a);
      }
    }

    function normalizeUrl(u){
      // se o usu√°rio colar "www..." sem http, a gente ajuda
      if(/^https?:\/\//i.test(u)) return u;
      return "https://" + u;
    }

    function openBackdrop(){
      modalBackdrop.classList.add("show");
      modalBackdrop.setAttribute("aria-hidden","false");
    }
    function closeBackdrop(){
      modalBackdrop.classList.remove("show");
      modalBackdrop.setAttribute("aria-hidden","true");
      current = null;
      eps = [];
      epsGrouped.innerHTML = "";
      epFormBox.style.display = "none";
    }

    btnFechar.onclick = closeBackdrop;
    modalBackdrop.addEventListener("click",(e)=>{
      if(e.target === modalBackdrop) closeBackdrop();
    });
    window.addEventListener("keydown",(e)=>{
      if(e.key==="Escape" && modalBackdrop.classList.contains("show")) closeBackdrop();
    });

    function openModalCreate(){
      modalMode = "create";
      current = null;
      modalTitle.textContent = "Nova m√≠dia";
      modalSub.textContent = "Preencha e clique em Salvar.";
      btnEditar.style.display = "none";
      btnExcluir.style.display = "none";

      // limpa
      mId.value = "";
      mNome.value = "";
      mTipo.value = "FILME";
      mStatus.value = "ASSISTINDO";
      mStreaming.value = "";
      mAno.value = "";
      mImagemUrl.value = "";
      mLinks.value = "";
      mAvaliacao.value = "";
      mSinopse.value = "";

      mPoster.src = safePoster("");
      mBadgeTipo.textContent = "-";
      mBadgeStatus.textContent = "-";
      mStarsText.textContent = "";
      starsMidia.textContent = "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
      linksViewBox.style.display = "none";

      epsSection.style.display = "none";

      setInputsEnabled(true);
      openBackdrop();
    }

    async function openModalView(m){
      modalMode = "view";
      current = m;

      modalTitle.textContent = "Detalhes";
      modalSub.textContent = `ID ${m.id}`;
      btnEditar.style.display = "inline-flex";
      btnExcluir.style.display = "inline-flex";

      // preencher
      mId.value = m.id;
      mNome.value = m.nome || "";
      mTipo.value = m.tipo || "FILME";
      mStatus.value = m.status || "ASSISTINDO";
      mStreaming.value = m.streaming || "";
      mAno.value = m.ano || "";
      mImagemUrl.value = m.imagem_url || "";
      mLinks.value = m.links || "";
      mAvaliacao.value = (sanitizeRating(m.avaliacao) ?? "").toString().replace(".", ",");
      mSinopse.value = m.sinopse || "";

      mPoster.src = safePoster(m.imagem_url);
      mBadgeTipo.textContent = m.tipo==="SERIE" ? "S√©rie" : "Filme";
      mBadgeStatus.textContent = statusLabel(m.status);
      mStarsText.textContent = `Avalia√ß√£o: ${sanitizeRating(m.avaliacao)===null ? "-" : sanitizeRating(m.avaliacao)}  ‚Ä¢  ${starsString(m.avaliacao)}`;
      starsMidia.textContent = starsString(m.avaliacao);

      fillLinksView(m.links);

      // epis√≥dios: se for s√©rie, carrega e mostra dentro do modal
      if(m.tipo === "SERIE"){
        epsSection.style.display = "block";
        await loadEps(m.id);
      } else {
        epsSection.style.display = "none";
      }

      setInputsEnabled(false);
      openBackdrop();
    }

    btnEditar.onclick = ()=>{
      if(!current) return;
      modalMode = "edit";
      modalTitle.textContent = "Editar m√≠dia";
      modalSub.textContent = `Editando: ${current.nome || ""}`;
      setInputsEnabled(true);
      btnEditar.style.display = "none";
      // no modo edit, links clic√°veis some (pra n√£o duplicar confus√£o)
      linksViewBox.style.display = "none";
    };

    btnSalvar.onclick = async ()=>{
      try{
        const payload = {
          nome: mNome.value.trim(),
          tipo: mTipo.value,
          status: mStatus.value,
          streaming: mStreaming.value.trim() || null,
          ano: mAno.value ? Number(mAno.value) : null,
          imagem_url: mImagemUrl.value.trim() || null,
          links: mLinks.value.trim() || null, // exige coluna links (text)
          avaliacao: sanitizeRating(mAvaliacao.value),
          sinopse: mSinopse.value.trim() || null
        };

        if(!payload.nome){
          msg("Nome √© obrigat√≥rio.","err");
          return;
        }

        if(modalMode === "create"){
          const { error } = await db.from("midias").insert(payload);
          if(error) throw error;
          msg("M√≠dia criada ‚úÖ","ok");
          await loadMidias(false);
          closeBackdrop();
          return;
        }

        // edit
        const id = Number(mId.value);
        const { error } = await db.from("midias").update(payload).eq("id", id);
        if(error) throw error;

        msg("M√≠dia atualizada ‚úÖ","ok");
        await loadMidias(false);

        // reabrir em modo view j√° atualizado
        const updated = midias.find(x=>x.id===id) || { ...current, ...payload, id };
        await openModalView(updated);
      }catch(err){
        console.error(err);

        // se n√£o existir coluna links, o erro costuma citar a coluna
        if(String(err?.message||"").toLowerCase().includes("links")){
          msg("Erro: crie a coluna 'links' na tabela midias (tipo text).","err");
        }else{
          msg("Erro ao salvar (veja o console).","err");
        }
      }
    };

    btnExcluir.onclick = async ()=>{
      if(!current) return;
      if(!confirm("Excluir esta m√≠dia?")) return;

      const { error } = await db.from("midias").delete().eq("id", current.id);
      if(error){
        console.error(error);
        msg("Erro ao excluir.","err");
        return;
      }
      msg("Exclu√≠do ‚úÖ","ok");
      await loadMidias(false);
      closeBackdrop();
    };

    // ========= Episodes =========
    btnNovoEp.onclick = ()=>{
      if(!current) return;
      epFormBox.style.display = "block";
      clearEpForm();
      epId.value = "";
      epTemp.focus();
    };
    btnCancelarEp.onclick = ()=>{
      epFormBox.style.display = "none";
    };

    function clearEpForm(){
      epId.value = "";
      epTemp.value = "";
      epNum.value = "";
      epTitulo.value = "";
      epResumo.value = "";
      epStatus.value = "AINDA_NAO_COMECEI";
      epAvaliacao.value = "";
      starsEp.textContent = "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
    }

    formEp.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!current) return;

      const payload = {
        midia_id: current.id,
        temporada: Number(epTemp.value),
        numero: Number(epNum.value),
        titulo: epTitulo.value.trim() || null,
        resumo: epResumo.value.trim() || null,
        status: epStatus.value,
        avaliacao: sanitizeRating(epAvaliacao.value)
      };

      if(!payload.temporada || !payload.numero){
        msg("Temporada e n√∫mero s√£o obrigat√≥rios.","err");
        return;
      }

      try{
        if(epId.value){
          const { error } = await db.from("episodios").update(payload).eq("id", Number(epId.value));
          if(error) throw error;
          msg("Epis√≥dio atualizado ‚úÖ","ok");
        }else{
          const { error } = await db.from("episodios").insert(payload);
          if(error) throw error;
          msg("Epis√≥dio salvo ‚úÖ","ok");
        }

        epFormBox.style.display = "none";
        clearEpForm();
        await loadEps(current.id);
      }catch(err){
        console.error(err);
        msg("Erro ao salvar epis√≥dio.","err");
      }
    });

    async function delEp(id){
      if(!confirm("Excluir epis√≥dio?")) return;
      const { error } = await db.from("episodios").delete().eq("id", id);
      if(error){
        console.error(error);
        msg("Erro ao excluir epis√≥dio.","err");
        return;
      }
      msg("Epis√≥dio exclu√≠do ‚úÖ","ok");
      await loadEps(current.id);
    }

    function editEp(ep){
      epFormBox.style.display = "block";
      epId.value = ep.id;
      epTemp.value = ep.temporada;
      epNum.value = ep.numero;
      epTitulo.value = ep.titulo || "";
      epResumo.value = ep.resumo || "";
      epStatus.value = ep.status || "AINDA_NAO_COMECEI";
      epAvaliacao.value = (sanitizeRating(ep.avaliacao) ?? "").toString().replace(".", ",");
      starsEp.textContent = starsString(ep.avaliacao);
    }

    function groupEps(){
      // temporada -> status -> lista
      const map = new Map();
      for(const ep of eps){
        const t = ep.temporada || 0;
        if(!map.has(t)) map.set(t, new Map());
        const st = ep.status || "AINDA_NAO_COMECEI";
        const m2 = map.get(t);
        if(!m2.has(st)) m2.set(st, []);
        m2.get(st).push(ep);
      }
      // ordena por temporada
      const seasons = [...map.keys()].sort((a,b)=>a-b);
      return {map, seasons};
    }

    function renderEpisodes(){
      epsGrouped.innerHTML = "";
      if(!current || current.tipo!=="SERIE"){
        return;
      }

      if(!eps.length){
        epsGrouped.innerHTML = `<div class="panel"><span class="small">Nenhum epis√≥dio cadastrado ainda.</span></div>`;
        return;
      }

      const { map, seasons } = groupEps();
      for(const temporada of seasons){
        const det = document.createElement("details");
        det.open = true;

        const totalSeason = [...map.get(temporada).values()].reduce((acc,arr)=>acc+arr.length,0);

        const sum = document.createElement("summary");
        sum.innerHTML = `Temporada ${temporada} <span class="small">(${totalSeason} epis√≥dio(s))</span>`;
        det.appendChild(sum);

        const wrap = document.createElement("div");
        wrap.className = "epWrap";

        // ordem de status
        const order = ["ASSISTINDO","ASSISTIDOS","AINDA_NAO_COMECEI"];
        for(const st of order){
          const list = map.get(temporada).get(st) || [];
          if(!list.length) continue;

          const title = document.createElement("div");
          title.className = "epGroupTitle";
          title.textContent = `${statusLabel(st)} (${list.length})`;
          wrap.appendChild(title);

          const table = document.createElement("table");
          table.className = "epTable";
          table.innerHTML = `
            <thead>
              <tr>
                <th style="width:90px">Epis√≥dio</th>
                <th>T√≠tulo / Resumo</th>
                <th style="width:140px">Nota</th>
                <th style="width:180px">A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          const tb = table.querySelector("tbody");

          // ordena epis√≥dio
          list.sort((a,b)=>(a.numero||0)-(b.numero||0));

          for(const ep of list){
            const tr = document.createElement("tr");
            const nota = sanitizeRating(ep.avaliacao);
            tr.innerHTML = `
              <td><b>E${String(ep.numero||0).padStart(2,"0")}</b></td>
              <td>
                <div style="font-weight:800">${escapeHtml(ep.titulo||"-")}</div>
                <div class="small" style="margin-top:2px;white-space:pre-wrap">${escapeHtml(ep.resumo||"")}</div>
              </td>
              <td>
                <div class="tag">
                  <span style="font-weight:900">${nota===null? "-" : String(nota).replace(".0","")}</span>
                  <span>${starsString(ep.avaliacao)}</span>
                </div>
              </td>
              <td></td>
            `;
            const td = tr.querySelector("td:last-child");
            const actions = document.createElement("div");
            actions.className = "epActions";

            const b1 = document.createElement("button");
            b1.className = "btn ghost small";
            b1.textContent = "Editar";
            b1.type = "button";
            b1.onclick = ()=>editEp(ep);

            const b2 = document.createElement("button");
            b2.className = "btn danger small";
            b2.textContent = "Excluir";
            b2.type = "button";
            b2.onclick = ()=>delEp(ep.id);

            actions.appendChild(b1);
            actions.appendChild(b2);
            td.appendChild(actions);

            tb.appendChild(tr);
          }

          wrap.appendChild(table);
          wrap.appendChild(document.createElement("div")).className="divider";
        }

        det.appendChild(wrap);
        epsGrouped.appendChild(det);
      }
    }

    // ========= Events =========
    [fStatus,fTipo].forEach(el=>el.addEventListener("change", renderList));
    [fNome,fNota].forEach(el=>el.addEventListener("input", renderList));

    // ========= Utils =========
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ========= Init =========
    (async ()=>{
      await loadMidias(false);
    })();
  </script>
</body>
</html>
