<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Minha Cole√ß√£o</title>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#f6f7fb;
      --card:#ffffff;
      --bd:#e5e7eb;
      --txt:#0f172a;
      --mut:#64748b;
      --pri:#4f46e5;
      --pri2:#eef2ff;
      --danger:#b91c1c;
      --shadow: 0 10px 30px rgba(15,23,42,.10);
      --r:16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:var(--bg);color:var(--txt)}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 14px 44px}
    header{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start;margin-bottom:12px}
    h1{margin:0;font-size:1.55rem;font-weight:700}
    .sub{margin:6px 0 0;color:var(--mut);font-size:.92rem}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .panel{background:var(--panel);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin:12px 0}
    .btn{border:0;border-radius:999px;padding:8px 14px;cursor:pointer;transition:.15s;white-space:nowrap;font-weight:600}
    .btn.primary{background:var(--pri);color:#fff;box-shadow:0 6px 18px rgba(79,70,229,.25)}
    .btn.primary:hover{background:#4338ca;transform:translateY(-1px)}
    .btn.secondary{background:var(--pri2);color:var(--pri)}
    .btn.ghost{background:transparent;border:1px solid var(--bd);color:var(--mut)}
    .btn.danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .btn.small{padding:6px 10px;font-size:.82rem}

    input,select,textarea{
      width:100%;padding:9px 10px;border-radius:12px;border:1px solid var(--bd);
      background:#fff;font-size:.93rem;outline:none
    }
    textarea{resize:vertical}
    label{font-size:.78rem;color:var(--mut);font-weight:700}
    .small{font-size:.83rem;color:var(--mut)}
    .divider{height:1px;background:var(--bd);margin:10px 0}

    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}

    /* Cards */
    .card{
      background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);
      padding:10px;display:flex;gap:10px;cursor:pointer;min-height:128px
    }
    .card:hover{outline:2px solid rgba(79,70,229,.15)}
    .poster{width:84px;flex:0 0 84px;border-radius:14px;overflow:hidden;background:#e5e7eb}
    .poster img{width:100%;height:116px;object-fit:cover;display:block}
    .content{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px}
    .titleLine{display:flex;gap:8px;align-items:flex-start}
    .title{
      font-weight:700;font-size:.98rem;min-width:0;flex:1;line-height:1.15;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
      word-break:break-word;
    }
    .badge{font-size:.7rem;padding:2px 8px;border-radius:999px;background:#e5e7eb;flex:0 0 auto}
    .meta{color:var(--mut);font-size:.82rem;display:flex;flex-wrap:wrap;gap:6px;min-height:18px}
    .footer{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .status{font-size:.74rem;border-radius:999px;padding:3px 9px;font-weight:700}
    .st-assistindo{background:#eef2ff;color:#4f46e5}
    .st-assistidos{background:#dcfce7;color:#15803d}
    .st-nao{background:#fef3c7;color:#92400e}
    .starsInline{font-size:.86rem;color:#0f172a;white-space:nowrap;display:flex;gap:6px;align-items:center}
    .starsInline .mut{color:var(--mut);font-weight:600}

    /* TOPS */
    .topsGrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media(max-width:980px){.topsGrid{grid-template-columns:1fr}}
    .topBox{background:#fff;border:1px solid var(--bd);border-radius:16px;box-shadow:0 10px 22px rgba(15,23,42,.06);overflow:hidden}
    .topHead{padding:10px 12px;background:#fafafa;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .topHead b{font-size:.95rem;font-weight:700}
    .topList{max-height:220px;overflow:auto;padding:6px 0}
    .topItem{display:flex;gap:10px;align-items:center;padding:8px 12px;border-bottom:1px solid #f1f5f9;cursor:pointer}
    .topItem:hover{background:#f8fafc}
    .topItem:last-child{border-bottom:0}
    .topItem .name{
      flex:1;min-width:0;font-weight:700;font-size:.86rem;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
      word-break:break-word;
    }
    .topItem .note{font-weight:600;color:var(--mut);font-size:.85rem;white-space:nowrap}
    .topItem .stars{white-space:nowrap;font-size:.85rem}

    /* ===== MODAL COM SCROLL ===== */
    .backdrop{
      position:fixed;inset:0;background:rgba(2,6,23,.55);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:50
    }
    .backdrop.show{display:flex}
    .modal{
      width:min(1100px, 100%);
      max-height:calc(100vh - 24px);
      background:#fff;border-radius:20px;box-shadow:0 24px 70px rgba(0,0,0,.35);
      overflow:hidden;
      display:flex;flex-direction:column;
    }
    .modalHeader{
      flex:0 0 auto;
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      padding:14px 14px 10px;background:linear-gradient(180deg, #ffffff, #fafafa);
      border-bottom:1px solid var(--bd)
    }
    .modalTitle{margin:0;font-size:1.1rem;font-weight:700}
    .modalSub{margin-top:4px}
    .modalBody{
      flex:1 1 auto;
      overflow:auto;         /* <<< SCROLL AQUI */
      padding:14px;
    }
    .modalFooter{
      flex:0 0 auto;
      padding:12px 14px;border-top:1px solid var(--bd);
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background:#fff;
    }

    .layout2{display:grid;grid-template-columns: 180px 1fr;gap:12px}
    @media(max-width:820px){.layout2{grid-template-columns:1fr}}
    .bigPoster{width:180px;height:260px;border-radius:16px;overflow:hidden;background:#e5e7eb}
    @media(max-width:820px){.bigPoster{width:100%;height:240px}}
    .bigPoster img{width:100%;height:100%;object-fit:cover;display:block}

    .formGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px 12px}
    .full{grid-column:1/-1}

    /* Rating */
    .ratingRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .starsBox{
      user-select:none;cursor:pointer;font-size:1.35rem;letter-spacing:1px;
      padding:4px 10px;border-radius:14px;border:1px dashed var(--bd);background:#fff
    }
    .starsBox.readonly{cursor:default;opacity:.95}
    .pill{background:var(--panel);border:1px solid var(--bd);border-radius:999px;padding:6px 10px;font-size:.82rem;color:var(--mut);font-weight:700}

    /* Details / advanced */
    details.adv{border:1px solid var(--bd);border-radius:14px;background:#fff;box-shadow:0 10px 22px rgba(15,23,42,.06);margin-top:12px}
    details.adv summary{cursor:pointer;padding:10px 12px;list-style:none;font-weight:700}
    details.adv summary::-webkit-details-marker{display:none}
    details.adv .advBody{padding:10px 12px;border-top:1px solid var(--bd)}

    /* Episodes */
    details.ep{border:1px solid var(--bd);border-radius:14px;background:#fff;box-shadow:0 10px 22px rgba(15,23,42,.06)}
    details.ep + details.ep{margin-top:10px}
    details.ep summary{cursor:pointer;padding:10px 12px;list-style:none;font-weight:700}
    details.ep summary::-webkit-details-marker{display:none}
    .epWrap{padding:10px 12px;border-top:1px solid var(--bd)}
    .epGroupTitle{font-weight:700;margin:0 0 8px}
    .epTable{width:100%;border-collapse:collapse;font-size:.86rem}
    .epTable th,.epTable td{padding:8px;border-bottom:1px solid var(--bd);text-align:left;vertical-align:top}
    .epTable th{background:#f3f4f6;font-weight:700}
    .epActions{display:flex;gap:6px;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:6px}

    /* TMDb Search */
    .tmdbBox{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:10px 12px;box-shadow:0 10px 22px rgba(15,23,42,.06)}
    .tmdbList{margin-top:8px;max-height:220px;overflow:auto;border:1px solid var(--bd);border-radius:14px}
    .tmdbItem{display:flex;gap:10px;padding:8px 10px;border-bottom:1px solid #f1f5f9;cursor:pointer;align-items:center}
    .tmdbItem:hover{background:#f8fafc}
    .tmdbItem:last-child{border-bottom:0}
    .tmdbThumb{width:40px;height:56px;border-radius:10px;overflow:hidden;background:#e5e7eb;flex:0 0 auto}
    .tmdbThumb img{width:100%;height:100%;object-fit:cover}
    .tmdbName{font-weight:700;font-size:.88rem;min-width:0;flex:1}
    .tmdbMeta{color:var(--mut);font-size:.78rem}

    /* Toast */
    .toast{
      position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;
      padding:10px 14px;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.25);
      opacity:0;transform:translateY(12px);transition:.2s;pointer-events:none;z-index:60
    }
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.err{background:#b91c1c}
    .toast.ok{background:#065f46}

    a.link{color:var(--pri);text-decoration:none;font-weight:700}
    a.link:hover{text-decoration:underline}
    .linksList{display:flex;flex-direction:column;gap:6px}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üé¨ Minha Cole√ß√£o</h1>
        <p class="sub">TOPs s√≥ aqui na p√°gina principal. Clique no card para detalhes. Editar abre o mesmo modal.</p>
      </div>
      <div class="row">
        <button class="btn secondary" id="btnRecarregar">Recarregar</button>
        <button class="btn primary" id="btnNovo">+ Nova m√≠dia</button>
      </div>
    </header>

    <!-- FILTROS -->
    <section class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <select id="fStatus" style="min-width:180px">
            <option value="">Todos status</option>
            <option value="ASSISTINDO">Assistindo</option>
            <option value="ASSISTIDOS">Assistidos</option>
            <option value="AINDA_NAO_COMECEI">Ainda n√£o comecei</option>
          </select>

          <select id="fTipo" style="min-width:150px">
            <option value="">Filmes + S√©ries</option>
            <option value="FILME">S√≥ Filmes</option>
            <option value="SERIE">S√≥ S√©ries</option>
          </select>

          <input id="fNome" placeholder="Buscar por nome..." style="min-width:240px" />
          <input id="fNota" placeholder="Nota m√≠nima (ex: 0,5 ou 3.5)" style="max-width:210px" />
        </div>

        <div class="small" id="countInfo"></div>
      </div>
    </section>

    <!-- TOPS -->
    <section class="panel">
      <div class="topsGrid">
        <div class="topBox">
          <div class="topHead"><b>‚≠ê Top 10 mais bem avaliados</b><span class="small" id="topBestCount"></span></div>
          <div class="topList" id="topBest"></div>
        </div>
        <div class="topBox">
          <div class="topHead"><b>‚¨áÔ∏è Top 10 menos avaliados</b><span class="small" id="topWorstCount"></span></div>
          <div class="topList" id="topWorst"></div>
        </div>
        <div class="topBox">
          <div class="topHead"><b>üÜï √öltimos 10 adicionados</b><span class="small" id="topLastCount"></span></div>
          <div class="topList" id="topLast"></div>
        </div>
      </div>
      <div class="small" style="margin-top:8px">Clique em um item do TOP para abrir o modal daquela m√≠dia.</div>
    </section>

    <!-- LISTA PRINCIPAL -->
    <section id="lista" class="grid"></section>
  </div>

  <!-- MODAL DETALHES/EDITAR -->
  <div class="backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div style="min-width:0">
          <h2 class="modalTitle" id="modalTitle">Detalhes</h2>
          <div class="small modalSub" id="modalSub"></div>
        </div>
        <div class="row">
          <button class="btn ghost small" id="btnFechar">Fechar</button>
        </div>
      </div>

      <div class="modalBody">

        <!-- TMDB (s√≥ no create/edit) -->
        <div id="tmdbSection" class="tmdbBox" style="display:none;margin-bottom:12px">
          <div class="row" style="justify-content:space-between;align-items:flex-end">
            <div>
              <div style="font-weight:700">Buscar no TMDb</div>
              <div class="small">Digite e clique Buscar. Selecione um resultado para preencher autom√°tico.</div>
            </div>
            <div class="row">
              <select id="tmdbType" style="min-width:140px">
                <option value="movie">Filme</option>
                <option value="tv">S√©rie</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:8px">
            <input id="tmdbQuery" placeholder="Ex: Matrix, Lost, Interstellar..." />
            <button class="btn secondary" id="btnTmdbSearch" type="button">Buscar</button>
            <button class="btn ghost" id="btnTmdbClear" type="button">Limpar</button>
          </div>

          <div id="tmdbResults" class="tmdbList" style="display:none"></div>
        </div>

        <div class="layout2">
          <div>
            <div class="bigPoster">
              <img id="mPoster" alt="poster" />
            </div>
            <div style="margin-top:10px" class="row">
              <span class="pill" id="mBadgeTipo">-</span>
              <span class="pill" id="mBadgeStatus">-</span>
            </div>
            <div style="margin-top:10px" class="small" id="mStarsText"></div>
          </div>

          <div style="min-width:0">
            <form id="formMidia" class="formGrid">
              <input type="hidden" id="mId" />

              <div class="full">
                <label>Nome</label>
                <input id="mNome" required />
              </div>

              <div>
                <label>Tipo</label>
                <select id="mTipo" required>
                  <option value="FILME">Filme</option>
                  <option value="SERIE">S√©rie</option>
                </select>
              </div>

              <div>
                <label>Status (seu)</label>
                <select id="mStatus">
                  <option value="ASSISTINDO">Assistindo</option>
                  <option value="ASSISTIDOS">Assistidos</option>
                  <option value="AINDA_NAO_COMECEI">Ainda n√£o comecei</option>
                </select>
              </div>

              <div>
                <label>Streaming (manual)</label>
                <input id="mStreaming" placeholder="Netflix, Prime..." />
              </div>

              <div>
                <label>Ano (manual)</label>
                <input id="mAno" type="number" min="1900" max="2100" />
              </div>

              <div class="full">
                <label>URL do p√¥ster</label>
                <input id="mImagemUrl" placeholder="https://...jpg" />
              </div>

              <div class="full">
                <label>LINK (um principal)</label>
                <input id="mLink" placeholder="https://..." />
              </div>

              <div class="full">
                <label>LINKS (v√°rios) ‚Äî 1 por linha</label>
                <textarea id="mLinks" rows="3" placeholder="https://...\nhttps://..."></textarea>
              </div>

              <div class="full">
                <label>Avalia√ß√£o (0 a 5, meia estrela)</label>
                <div class="ratingRow">
                  <div class="starsBox" id="starsMidia" title="Clique para definir (meia estrela tamb√©m)">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                  <input id="mAvaliacao" placeholder="Ex: 0,5 ou 4.5" inputmode="decimal" style="max-width:220px" />
                  <span class="small">Aceita v√≠rgula ou ponto</span>
                </div>
              </div>

              <div class="full">
                <label>Sinopse</label>
                <textarea id="mSinopse" rows="3" placeholder="Opcional"></textarea>
              </div>

              <!-- Links clic√°veis (s√≥ view) -->
              <div class="full" id="linksViewBox" style="display:none">
                <label>Links cadastrados</label>
                <div class="linksList" id="linksView"></div>
              </div>
            </form>

            <!-- CAMPOS AVAN√áADOS (TMDb/IMDb) -->
            <details class="adv" id="advBox">
              <summary>Campos avan√ßados (TMDb/IMDb)</summary>
              <div class="advBody">
                <div class="formGrid">
                  <div>
                    <label>tmdb_id</label>
                    <input id="mTmdbId" class="mono" />
                  </div>
                  <div>
                    <label>imdb_id</label>
                    <input id="mImdbId" class="mono" />
                  </div>

                  <div class="full">
                    <label>t√≠tulo original</label>
                    <input id="mTituloOriginal" />
                  </div>

                  <div>
                    <label>idioma_original</label>
                    <input id="mIdiomaOriginal" class="mono" />
                  </div>

                  <div>
                    <label>tagline</label>
                    <input id="mTagline" />
                  </div>

                  <div>
                    <label>status_oficial</label>
                    <input id="mStatusOficial" />
                  </div>

                  <div>
                    <label>vote_average</label>
                    <input id="mVoteAverage" inputmode="decimal" placeholder="Ex: 7.85" />
                  </div>

                  <div>
                    <label>vote_count</label>
                    <input id="mVoteCount" type="number" min="0" />
                  </div>

                  <div>
                    <label>popularity</label>
                    <input id="mPopularity" inputmode="decimal" placeholder="Ex: 123.456" />
                  </div>

                  <div>
                    <label>data_lancamento</label>
                    <input id="mDataLancamento" type="date" />
                  </div>

                  <div>
                    <label>first_air_date</label>
                    <input id="mFirstAir" type="date" />
                  </div>

                  <div>
                    <label>last_air_date</label>
                    <input id="mLastAir" type="date" />
                  </div>

                  <div>
                    <label>runtime (min)</label>
                    <input id="mRuntime" type="number" min="0" />
                  </div>

                  <div>
                    <label>episode_run_time (JSON array)</label>
                    <input id="mEpRunTime" class="mono" placeholder='[42,45]' />
                  </div>

                  <div>
                    <label>n¬∫ temporadas</label>
                    <input id="mSeasons" type="number" min="0" />
                  </div>

                  <div>
                    <label>n¬∫ epis√≥dios</label>
                    <input id="mEpisodes" type="number" min="0" />
                  </div>

                  <div class="full">
                    <label>production_companies (JSON)</label>
                    <textarea id="mProdCompanies" class="mono" rows="2"></textarea>
                  </div>

                  <div class="full">
                    <label>production_countries (JSON)</label>
                    <textarea id="mProdCountries" class="mono" rows="2"></textarea>
                  </div>

                  <div class="full">
                    <label>spoken_languages (JSON)</label>
                    <textarea id="mSpokenLang" class="mono" rows="2"></textarea>
                  </div>

                  <div class="full">
                    <label>networks (JSON)</label>
                    <textarea id="mNetworks" class="mono" rows="2"></textarea>
                  </div>

                  <div class="full">
                    <label>origin_country (JSON)</label>
                    <textarea id="mOriginCountry" class="mono" rows="2"></textarea>
                  </div>

                  <div class="full">
                    <label>cast_data (JSON)</label>
                    <textarea id="mCast" class="mono" rows="3"></textarea>
                  </div>

                  <div class="full">
                    <label>keywords (JSON)</label>
                    <textarea id="mKeywords" class="mono" rows="2"></textarea>
                  </div>

                  <div class="full">
                    <label>videos (JSON)</label>
                    <textarea id="mVideos" class="mono" rows="2"></textarea>
                  </div>

                  <div class="full">
                    <label>images (JSON) (posters/backdrops/logos)</label>
                    <textarea id="mImages" class="mono" rows="2"></textarea>
                  </div>

                  <div class="full">
                    <label>watch_providers (JSON)</label>
                    <textarea id="mWatchProviders" class="mono" rows="2"></textarea>
                  </div>

                  <div class="full">
                    <label>belongs_to_collection (JSON)</label>
                    <textarea id="mCollection" class="mono" rows="2"></textarea>
                  </div>
                </div>

                <div class="small" style="margin-top:8px">
                  Dica: o TMDb preenche boa parte desses campos automaticamente. Voc√™ pode editar manualmente se quiser.
                </div>
              </div>
            </details>
          </div>
        </div>

        <!-- EPIS√ìDIOS (s√≥ pra s√©rie) -->
        <div id="epsSection" style="display:none;margin-top:14px">
          <div class="divider"></div>
          <div class="row" style="justify-content:space-between;align-items:flex-end">
            <div>
              <h3 style="margin:0;font-size:1.02rem;font-weight:700">Guia de Epis√≥dios</h3>
              <div class="small">Agrupado por temporada e por status.</div>
            </div>
            <div class="row">
              <button class="btn secondary small" id="btnNovoEp" type="button">+ Epis√≥dio</button>
            </div>
          </div>

          <div id="epFormBox" class="panel" style="display:none;margin-top:10px">
            <div class="row" style="justify-content:space-between">
              <div style="font-weight:700">Cadastrar/Editar epis√≥dio</div>
              <button class="btn ghost small" id="btnCancelarEp" type="button">Fechar</button>
            </div>
            <div class="divider"></div>

            <form id="formEp" class="formGrid">
              <input type="hidden" id="epId" />

              <div>
                <label>Temporada</label>
                <input id="epTemp" type="number" min="1" required />
              </div>

              <div>
                <label>N¬∫ epis√≥dio</label>
                <input id="epNum" type="number" min="1" required />
              </div>

              <div class="full">
                <label>T√≠tulo</label>
                <input id="epTitulo" placeholder="Opcional" />
              </div>

              <div class="full">
                <label>Resumo</label>
                <textarea id="epResumo" rows="3" placeholder="Resumo do epis√≥dio"></textarea>
              </div>

              <div>
                <label>Status</label>
                <select id="epStatus">
                  <option value="AINDA_NAO_COMECEI">Ainda n√£o comecei</option>
                  <option value="ASSISTINDO">Assistindo</option>
                  <option value="ASSISTIDOS">Assistidos</option>
                </select>
              </div>

              <div class="full">
                <label>Avalia√ß√£o do epis√≥dio (0 a 5, meia estrela)</label>
                <div class="ratingRow">
                  <div class="starsBox" id="starsEp">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                  <input id="epAvaliacao" placeholder="Ex: 0,5 ou 3.5" inputmode="decimal" style="max-width:220px" />
                </div>
              </div>

              <div class="row full">
                <button class="btn primary" type="submit">Salvar epis√≥dio</button>
              </div>
            </form>
          </div>

          <div id="epsGrouped" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="modalFooter">
        <div class="row">
          <button class="btn danger" id="btnExcluir">Excluir</button>
        </div>
        <div class="row">
          <button class="btn ghost" id="btnEditar">Editar</button>
          <button class="btn primary" id="btnSalvar">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ======= SUPABASE =======
    const SUPABASE_URL = "https://koytoiwfvwzjvgcqhlal.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtveXRvaXdmdnd6anZnY3FobGFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDExNzAsImV4cCI6MjA3OTcxNzE3MH0.mrMRUGJFqzOBjj7M4giHcWr5qsqUn_0woVMFikDxrjM";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ======= TMDb =======
    const TMDB_API_KEY = "34d1febeb2c306bd928d270c1990c076";
    const TMDB_BEARER = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIzNGQxZmViZWIyYzMwNmJkOTI4ZDI3MGMxOTkwYzA3NiIsIm5iZiI6MTc2NDU0NzczNC43MDIwMDAxLCJzdWIiOiI2OTJjZGM5Njg1ZTg0OGEwYjAyNmVhZTYiLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.Htppj_TDovsK4-xrjzwZrBduPQJZSy9HErIjkvm8DgY";
    const TMDB_IMG = "https://image.tmdb.org/t/p/w500";

    // ========= Toast =========
    const toast = document.getElementById("toast");
    function msg(text, type="ok"){
      toast.className = "toast " + (type==="err"?"err":"ok");
      toast.textContent = text;
      toast.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>toast.classList.remove("show"), 2400);
    }

    // ========= Rating (0,5) =========
    function sanitizeRating(value){
      if (value === null || value === undefined) return null;
      let s = String(value).trim();
      if (!s) return null;
      s = s.replace(",", ".");
      let n = Number(s);
      if (!Number.isFinite(n)) return null;
      n = Math.max(0, Math.min(5, n));
      n = Math.round(n * 2) / 2;
      return n;
    }
    function starsString(r){
      const n = sanitizeRating(r);
      if (n === null) return "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
      const full = Math.floor(n);
      const half = (n - full) >= 0.5 ? 1 : 0;
      const empty = Math.max(0, 5 - full - half);
      return "‚òÖ".repeat(full) + (half ? "‚Ø®" : "") + "‚òÜ".repeat(empty);
    }
    function bindStars(starsEl, inputEl){
      function sync(){ starsEl.textContent = starsString(inputEl.value); }
      starsEl.addEventListener("click", (ev)=>{
        if(starsEl.classList.contains("readonly")) return;
        const rect = starsEl.getBoundingClientRect();
        const x = ev.clientX - rect.left;
        const ratio = Math.max(0, Math.min(1, x / rect.width));
        let rating = Math.round(ratio * 10) / 2;
        rating = Math.max(0, Math.min(5, rating));
        inputEl.value = String(rating).replace(".0","").replace(".", ",");
        sync();
      });
      inputEl.addEventListener("input", sync);
      sync();
    }

    function statusLabel(s){
      if(s==="ASSISTINDO") return "Assistindo";
      if(s==="ASSISTIDOS") return "Assistidos";
      return "Ainda n√£o comecei";
    }
    function statusClass(s){
      if(s==="ASSISTINDO") return "st-assistindo";
      if(s==="ASSISTIDOS") return "st-assistidos";
      return "st-nao";
    }
    function safePoster(url){
      return url && String(url).trim()
        ? url.trim()
        : "https://via.placeholder.com/300x450.png?text=Sem+Imagem";
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function normalizeUrl(u){
      if(/^https?:\/\//i.test(u)) return u;
      return "https://" + u;
    }

    // ========= JSON helpers =========
    function tryParseJSON(text){
      const s = String(text||"").trim();
      if(!s) return null;
      try{ return JSON.parse(s); }catch{ return "__INVALID__"; }
    }
    function toJsonString(v){
      if(v === null || v === undefined) return "";
      try{ return JSON.stringify(v, null, 2); }catch{ return ""; }
    }

    // ========= State =========
    let midias = [];
    let current = null;
    let modalMode = "view"; // view | edit | create
    let eps = [];

    // ========= Filters =========
    const fStatus = document.getElementById("fStatus");
    const fTipo = document.getElementById("fTipo");
    const fNome = document.getElementById("fNome");
    const fNota = document.getElementById("fNota");
    const countInfo = document.getElementById("countInfo");
    const lista = document.getElementById("lista");

    // TOPS refs
    const topBest = document.getElementById("topBest");
    const topWorst = document.getElementById("topWorst");
    const topLast = document.getElementById("topLast");
    const topBestCount = document.getElementById("topBestCount");
    const topWorstCount = document.getElementById("topWorstCount");
    const topLastCount = document.getElementById("topLastCount");

    // ========= Modal refs =========
    const modalBackdrop = document.getElementById("modalBackdrop");
    const btnFechar = document.getElementById("btnFechar");
    const btnEditar = document.getElementById("btnEditar");
    const btnSalvar = document.getElementById("btnSalvar");
    const btnExcluir = document.getElementById("btnExcluir");

    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");
    const mPoster = document.getElementById("mPoster");
    const mBadgeTipo = document.getElementById("mBadgeTipo");
    const mBadgeStatus = document.getElementById("mBadgeStatus");
    const mStarsText = document.getElementById("mStarsText");

    const mId = document.getElementById("mId");
    const mNome = document.getElementById("mNome");
    const mTipo = document.getElementById("mTipo");
    const mStatus = document.getElementById("mStatus");
    const mStreaming = document.getElementById("mStreaming");
    const mAno = document.getElementById("mAno");
    const mImagemUrl = document.getElementById("mImagemUrl");
    const mLink = document.getElementById("mLink");
    const mLinks = document.getElementById("mLinks");
    const mAvaliacao = document.getElementById("mAvaliacao");
    const mSinopse = document.getElementById("mSinopse");

    const starsMidia = document.getElementById("starsMidia");
    bindStars(starsMidia, mAvaliacao);

    const linksViewBox = document.getElementById("linksViewBox");
    const linksView = document.getElementById("linksView");

    // Advanced fields (cast -> cast_data)
    const advBox = document.getElementById("advBox");
    const mTmdbId = document.getElementById("mTmdbId");
    const mImdbId = document.getElementById("mImdbId");
    const mTituloOriginal = document.getElementById("mTituloOriginal");
    const mIdiomaOriginal = document.getElementById("mIdiomaOriginal");
    const mTagline = document.getElementById("mTagline");
    const mStatusOficial = document.getElementById("mStatusOficial");
    const mVoteAverage = document.getElementById("mVoteAverage");
    const mVoteCount = document.getElementById("mVoteCount");
    const mPopularity = document.getElementById("mPopularity");
    const mDataLancamento = document.getElementById("mDataLancamento");
    const mFirstAir = document.getElementById("mFirstAir");
    const mLastAir = document.getElementById("mLastAir");
    const mRuntime = document.getElementById("mRuntime");
    const mEpRunTime = document.getElementById("mEpRunTime");
    const mSeasons = document.getElementById("mSeasons");
    const mEpisodes = document.getElementById("mEpisodes");
    const mProdCompanies = document.getElementById("mProdCompanies");
    const mProdCountries = document.getElementById("mProdCountries");
    const mSpokenLang = document.getElementById("mSpokenLang");
    const mNetworks = document.getElementById("mNetworks");
    const mOriginCountry = document.getElementById("mOriginCountry");
    const mCast = document.getElementById("mCast");          // formul√°rio
    const mKeywords = document.getElementById("mKeywords");
    const mVideos = document.getElementById("mVideos");
    const mImages = document.getElementById("mImages");
    const mWatchProviders = document.getElementById("mWatchProviders");
    const mCollection = document.getElementById("mCollection");

    // TMDb UI
    const tmdbSection = document.getElementById("tmdbSection");
    const tmdbType = document.getElementById("tmdbType");
    const tmdbQuery = document.getElementById("tmdbQuery");
    const btnTmdbSearch = document.getElementById("btnTmdbSearch");
    const btnTmdbClear = document.getElementById("btnTmdbClear");
    const tmdbResults = document.getElementById("tmdbResults");

    // ========= Episodes UI =========
    const epsSection = document.getElementById("epsSection");
    const btnNovoEp = document.getElementById("btnNovoEp");
    const epFormBox = document.getElementById("epFormBox");
    const btnCancelarEp = document.getElementById("btnCancelarEp");
    const formEp = document.getElementById("formEp");
    const epId = document.getElementById("epId");
    const epTemp = document.getElementById("epTemp");
    const epNum = document.getElementById("epNum");
    const epTitulo = document.getElementById("epTitulo");
    const epResumo = document.getElementById("epResumo");
    const epStatus = document.getElementById("epStatus");
    const epAvaliacao = document.getElementById("epAvaliacao");
    const starsEp = document.getElementById("starsEp");
    bindStars(starsEp, epAvaliacao);
    const epsGrouped = document.getElementById("epsGrouped");

    // ========= Buttons =========
    document.getElementById("btnNovo").onclick = ()=>openModalCreate();
    document.getElementById("btnRecarregar").onclick = ()=>loadMidias(true);

    // ========= Load =========
    async function loadMidias(showToast=false){
      const { data, error } = await db.from("midias").select("*").order("id",{ascending:false});
      if(error){
        console.error(error);
        msg("Erro ao carregar m√≠dias", "err");
        return;
      }
      midias = data || [];
      renderAll();
      if(showToast) msg("Atualizado ‚úÖ","ok");
    }

    async function loadEps(midiaId){
      const { data, error } = await db.from("episodios")
        .select("*")
        .eq("midia_id", midiaId)
        .order("temporada",{ascending:true})
        .order("numero",{ascending:true});

      if(error){
        console.error(error);
        msg("Erro ao carregar epis√≥dios","err");
        eps = [];
        renderEpisodes();
        return;
      }
      eps = data || [];
      renderEpisodes();
    }

    function renderAll(){
      renderTops();
      renderList();
    }

    // ========= TOPS =========
    function getCreatedKey(m){
      if(m.created_at) return new Date(m.created_at).getTime() || 0;
      return Number(m.id)||0;
    }
    function renderTopList(container, items){
      container.innerHTML = "";
      if(!items.length){
        container.innerHTML = `<div class="small" style="padding:10px 12px">Sem dados.</div>`;
        return;
      }
      for(const m of items){
        const div = document.createElement("div");
        div.className = "topItem";
        div.onclick = ()=>openModalView(m);
        const n = sanitizeRating(m.avaliacao);
        div.innerHTML = `
          <div class="name">${escapeHtml(m.nome||"-")}</div>
          <div class="note">${n===null? "-" : String(n).replace(".0","")}</div>
          <div class="stars">${starsString(m.avaliacao)}</div>
        `;
        container.appendChild(div);
      }
    }
    function renderTops(){
      const rated = midias.map(m=>({m, n:sanitizeRating(m.avaliacao)})).filter(x=>x.n !== null);
      const best = [...rated].sort((a,b)=>b.n-a.n || (getCreatedKey(b.m)-getCreatedKey(a.m))).slice(0,10).map(x=>x.m);
      const worst = [...rated].sort((a,b)=>a.n-b.n || (getCreatedKey(b.m)-getCreatedKey(a.m))).slice(0,10).map(x=>x.m);
      const last = [...midias].sort((a,b)=>getCreatedKey(b)-getCreatedKey(a)).slice(0,10);

      topBestCount.textContent = `(${best.length})`;
      topWorstCount.textContent = `(${worst.length})`;
      topLastCount.textContent = `(${last.length})`;

      renderTopList(topBest, best);
      renderTopList(topWorst, worst);
      renderTopList(topLast, last);
    }

    // ========= LIST =========
    function getFiltered(){
      let arr = [...midias];
      const st = fStatus.value;
      const tp = fTipo.value;
      const q = fNome.value.trim().toLowerCase();
      const minNota = sanitizeRating(fNota.value);

      if(st) arr = arr.filter(m=>m.status===st);
      if(tp) arr = arr.filter(m=>m.tipo===tp);
      if(q) arr = arr.filter(m=>(m.nome||"").toLowerCase().includes(q));
      if(minNota !== null){
        arr = arr.filter(m=>{
          const n = sanitizeRating(m.avaliacao);
          return n !== null && n >= minNota;
        });
      }
      return arr;
    }

    function renderList(){
      const arr = getFiltered();
      countInfo.textContent = `${arr.length} item(ns)`;
      lista.innerHTML = "";

      if(!arr.length){
        lista.innerHTML = `<div class="panel"><span class="small">Nada encontrado com os filtros.</span></div>`;
        return;
      }

      for(const m of arr){
        const card = document.createElement("div");
        card.className = "card";
        card.onclick = ()=>openModalView(m);

        const poster = document.createElement("div");
        poster.className = "poster";
        poster.innerHTML = `<img src="${safePoster(m.imagem_url)}" alt="">`;

        const content = document.createElement("div");
        content.className = "content";

        const tl = document.createElement("div");
        tl.className = "titleLine";
        tl.innerHTML = `
          <div class="title">${escapeHtml(m.nome || "(sem nome)")}</div>
          <span class="badge">${m.tipo==="SERIE"?"S√©rie":"Filme"}</span>
        `;

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = [m.ano, m.streaming].filter(Boolean).join(" ‚Ä¢ ");

        const footer = document.createElement("div");
        footer.className = "footer";

        const st = document.createElement("span");
        st.className = `status ${statusClass(m.status)}`;
        st.textContent = statusLabel(m.status);

        const stars = document.createElement("div");
        stars.className = "starsInline";
        const n = sanitizeRating(m.avaliacao);
        stars.innerHTML = `<span class="mut">${n===null? "-" : String(n).replace(".0","")}</span> <span>${starsString(m.avaliacao)}</span>`;

        footer.appendChild(st);
        footer.appendChild(stars);

        content.appendChild(tl);
        content.appendChild(meta);
        content.appendChild(footer);

        card.appendChild(poster);
        card.appendChild(content);

        lista.appendChild(card);
      }
    }

    // ========= Modal helpers =========
    function setInputsEnabled(enabled){
      const fields = [
        mNome,mTipo,mStatus,mStreaming,mAno,mImagemUrl,mLink,mLinks,mAvaliacao,mSinopse,
        mTmdbId,mImdbId,mTituloOriginal,mIdiomaOriginal,mTagline,mStatusOficial,mVoteAverage,mVoteCount,mPopularity,
        mDataLancamento,mFirstAir,mLastAir,mRuntime,mEpRunTime,mSeasons,mEpisodes,mProdCompanies,mProdCountries,
        mSpokenLang,mNetworks,mOriginCountry,mCast,mKeywords,mVideos,mImages,mWatchProviders,mCollection
      ];
      fields.forEach(el=> el.disabled = !enabled);
      starsMidia.classList.toggle("readonly", !enabled);
      btnSalvar.style.display = enabled ? "inline-flex" : "none";
      advBox.open = enabled;
    }

    function fillLinksView(){
      linksView.innerHTML = "";
      const all = [];

      const link1 = (mLink.value || "").trim();
      if(link1) all.push(link1);

      const text = (mLinks.value || "").trim();
      if(text){
        text.split("\n").map(s=>s.trim()).filter(Boolean).forEach(u=>all.push(u));
      }

      if(!all.length){
        linksViewBox.style.display = "none";
        return;
      }
      linksViewBox.style.display = "block";

      const uniq = [...new Set(all)];
      for(const u of uniq){
        const a = document.createElement("a");
        a.className = "link";
        a.href = normalizeUrl(u);
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = u;
        linksView.appendChild(a);
      }
    }

    function openBackdrop(){
      modalBackdrop.classList.add("show");
      modalBackdrop.setAttribute("aria-hidden","false");
    }
    function closeBackdrop(){
      modalBackdrop.classList.remove("show");
      modalBackdrop.setAttribute("aria-hidden","true");
      current = null;
      eps = [];
      epsGrouped.innerHTML = "";
      epFormBox.style.display = "none";
      tmdbResults.style.display="none";
      tmdbResults.innerHTML="";
      tmdbQuery.value="";
    }

    btnFechar.onclick = closeBackdrop;
    modalBackdrop.addEventListener("click",(e)=>{ if(e.target === modalBackdrop) closeBackdrop(); });
    window.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && modalBackdrop.classList.contains("show")) closeBackdrop(); });

    function showTmdbBox(show){
      tmdbSection.style.display = show ? "block" : "none";
    }

    function clearAdvanced(){
      [
        mTmdbId,mImdbId,mTituloOriginal,mIdiomaOriginal,mTagline,mStatusOficial,mVoteAverage,mVoteCount,mPopularity,
        mDataLancamento,mFirstAir,mLastAir,mRuntime,mEpRunTime,mSeasons,mEpisodes,mProdCompanies,mProdCountries,mSpokenLang,
        mNetworks,mOriginCountry,mCast,mKeywords,mVideos,mImages,mWatchProviders,mCollection
      ].forEach(el=>el.value="");
    }

    function openModalCreate(){
      modalMode = "create";
      current = null;

      modalTitle.textContent = "Nova m√≠dia";
      modalSub.textContent = "Preencha e clique em Salvar (ou use TMDb acima).";
      btnEditar.style.display = "none";
      btnExcluir.style.display = "none";

      showTmdbBox(true);

      mId.value = "";
      mNome.value = "";
      mTipo.value = "FILME";
      mStatus.value = "ASSISTINDO";
      mStreaming.value = "";
      mAno.value = "";
      mImagemUrl.value = "";
      mLink.value = "";
      mLinks.value = "";
      mAvaliacao.value = "";
      mSinopse.value = "";
      clearAdvanced();

      mPoster.src = safePoster("");
      mBadgeTipo.textContent = "-";
      mBadgeStatus.textContent = "-";
      mStarsText.textContent = "";
      document.getElementById("starsMidia").textContent = "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";

      linksViewBox.style.display = "none";
      epsSection.style.display = "none";

      setInputsEnabled(true);
      openBackdrop();
    }

    async function openModalView(m){
      modalMode = "view";
      current = m;

      modalTitle.textContent = "Detalhes";
      modalSub.textContent = `ID ${m.id}`;
      btnEditar.style.display = "inline-flex";
      btnExcluir.style.display = "inline-flex";

      showTmdbBox(false);

      mId.value = m.id;
      mNome.value = m.nome || "";
      mTipo.value = m.tipo || "FILME";
      mStatus.value = m.status || "ASSISTINDO";
      mStreaming.value = m.streaming || "";
      mAno.value = m.ano || "";
      mImagemUrl.value = m.imagem_url || "";
      mLink.value = m.link || "";
      mLinks.value = m.links || "";
      mAvaliacao.value = (sanitizeRating(m.avaliacao) ?? "").toString().replace(".", ",");
      mSinopse.value = m.sinopse || "";

      // advanced
      mTmdbId.value = (m.tmdb_id ?? "");
      mImdbId.value = (m.imdb_id ?? "");
      mTituloOriginal.value = (m.titulo_original ?? "");
      mIdiomaOriginal.value = (m.idioma_original ?? "");
      mTagline.value = (m.tagline ?? "");
      mStatusOficial.value = (m.status_oficial ?? "");
      mVoteAverage.value = (m.vote_average ?? "");
      mVoteCount.value = (m.vote_count ?? "");
      mPopularity.value = (m.popularity ?? "");
      mDataLancamento.value = (m.data_lancamento ?? "");
      mFirstAir.value = (m.first_air_date ?? "");
      mLastAir.value = (m.last_air_date ?? "");
      mRuntime.value = (m.runtime ?? "");
      mEpRunTime.value = toJsonString(m.episode_run_time);
      mSeasons.value = (m.number_of_seasons ?? "");
      mEpisodes.value = (m.number_of_episodes ?? "");
      mProdCompanies.value = toJsonString(m.production_companies);
      mProdCountries.value = toJsonString(m.production_countries);
      mSpokenLang.value = toJsonString(m.spoken_languages);
      mNetworks.value = toJsonString(m.networks);
      mOriginCountry.value = toJsonString(m.origin_country);
      mCast.value = toJsonString(m.cast_data);  // <<< cast_data
      mKeywords.value = toJsonString(m.keywords);
      mVideos.value = toJsonString(m.videos);
      mImages.value = toJsonString(m.images);
      mWatchProviders.value = toJsonString(m.watch_providers);
      mCollection.value = toJsonString(m.belongs_to_collection);

      mPoster.src = safePoster(m.imagem_url);
      mBadgeTipo.textContent = m.tipo==="SERIE" ? "S√©rie" : "Filme";
      mBadgeStatus.textContent = statusLabel(m.status);

      const n = sanitizeRating(m.avaliacao);
      mStarsText.textContent = `Avalia√ß√£o: ${n===null ? "-" : n}  ‚Ä¢  ${starsString(m.avaliacao)}`;
      document.getElementById("starsMidia").textContent = starsString(m.avaliacao);

      fillLinksView();

      if(m.tipo === "SERIE"){
        epsSection.style.display = "block";
        await loadEps(m.id);
      } else {
        epsSection.style.display = "none";
      }

      setInputsEnabled(false);
      openBackdrop();
    }

    btnEditar.onclick = ()=>{
      if(!current) return;
      modalMode = "edit";
      modalTitle.textContent = "Editar m√≠dia";
      modalSub.textContent = `Editando: ${current.nome || ""}`;
      setInputsEnabled(true);
      btnEditar.style.display = "none";
      linksViewBox.style.display = "none";
      showTmdbBox(true);
      tmdbType.value = (mTipo.value === "SERIE") ? "tv" : "movie";
    };

    function numberOrNull(v){
      const s = String(v ?? "").trim();
      if(!s) return null;
      const n = Number(s.replace(",", "."));
      return Number.isFinite(n) ? n : null;
    }
    function intOrNull(v){
      const s = String(v ?? "").trim();
      if(!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? Math.trunc(n) : null;
    }
    function dateOrNull(v){
      const s = String(v ?? "").trim();
      return s ? s : null;
    }
    function jsonOrNullFromField(fieldEl){
      const parsed = tryParseJSON(fieldEl.value);
      if(parsed === "__INVALID__"){
        throw new Error("JSON inv√°lido em: " + fieldEl.id);
      }
      return parsed;
    }

    document.getElementById("btnSalvar").onclick = async ()=>{
      try{
        const payload = {
          nome: mNome.value.trim(),
          tipo: mTipo.value,
          status: mStatus.value,
          streaming: mStreaming.value.trim() || null,
          ano: mAno.value ? Number(mAno.value) : null,
          imagem_url: mImagemUrl.value.trim() || null,
          link: mLink.value.trim() || null,
          links: mLinks.value.trim() || null,
          avaliacao: sanitizeRating(mAvaliacao.value),
          sinopse: mSinopse.value.trim() || null,

          tmdb_id: intOrNull(mTmdbId.value),
          imdb_id: mImdbId.value.trim() || null,
          titulo_original: mTituloOriginal.value.trim() || null,
          idioma_original: mIdiomaOriginal.value.trim() || null,
          tagline: mTagline.value.trim() || null,
          status_oficial: mStatusOficial.value.trim() || null,
          vote_average: numberOrNull(mVoteAverage.value),
          vote_count: intOrNull(mVoteCount.value),
          popularity: numberOrNull(mPopularity.value),
          data_lancamento: dateOrNull(mDataLancamento.value),
          first_air_date: dateOrNull(mFirstAir.value),
          last_air_date: dateOrNull(mLastAir.value),
          runtime: intOrNull(mRuntime.value),
          episode_run_time: jsonOrNullFromField(mEpRunTime),
          number_of_seasons: intOrNull(mSeasons.value),
          number_of_episodes: intOrNull(mEpisodes.value),

          production_companies: jsonOrNullFromField(mProdCompanies),
          production_countries: jsonOrNullFromField(mProdCountries),
          spoken_languages: jsonOrNullFromField(mSpokenLang),
          networks: jsonOrNullFromField(mNetworks),
          origin_country: jsonOrNullFromField(mOriginCountry),

          cast_data: jsonOrNullFromField(mCast),         // <<< cast_data
          keywords: jsonOrNullFromField(mKeywords),
          videos: jsonOrNullFromField(mVideos),
          images: jsonOrNullFromField(mImages),
          watch_providers: jsonOrNullFromField(mWatchProviders),
          belongs_to_collection: jsonOrNullFromField(mCollection),
        };

        if(!payload.nome){
          msg("Nome √© obrigat√≥rio.","err");
          return;
        }

        if(payload.data_lancamento && !payload.ano){
          payload.ano = Number(String(payload.data_lancamento).slice(0,4)) || null;
        }
        if(payload.first_air_date && !payload.ano && payload.tipo === "SERIE"){
          payload.ano = Number(String(payload.first_air_date).slice(0,4)) || null;
        }

        if(modalMode === "create"){
          const { error } = await db.from("midias").insert(payload);
          if(error) throw error;
          msg("M√≠dia criada ‚úÖ","ok");
          await loadMidias(false);
          closeBackdrop();
          return;
        }

        const id = Number(mId.value);
        const { error } = await db.from("midias").update(payload).eq("id", id);
        if(error) throw error;

        msg("M√≠dia atualizada ‚úÖ","ok");
        await loadMidias(false);

        const updated = midias.find(x=>x.id===id) || { ...current, ...payload, id };
        await openModalView(updated);
      }catch(err){
        console.error(err);
        msg(String(err?.message||"Erro ao salvar (veja o console)."), "err");
      }
    };

    btnExcluir.onclick = async ()=>{
      if(!current) return;
      if(!confirm("Excluir esta m√≠dia?")) return;
      const { error } = await db.from("midias").delete().eq("id", current.id);
      if(error){
        console.error(error);
        msg("Erro ao excluir.","err");
        return;
      }
      msg("Exclu√≠do ‚úÖ","ok");
      await loadMidias(false);
      closeBackdrop();
    };

    // ========= Episodes =========
    btnNovoEp.onclick = ()=>{
      if(!current) return;
      epFormBox.style.display = "block";
      clearEpForm();
      epId.value = "";
      epTemp.focus();
    };
    btnCancelarEp.onclick = ()=>{ epFormBox.style.display = "none"; };

    function clearEpForm(){
      epId.value = "";
      epTemp.value = "";
      epNum.value = "";
      epTitulo.value = "";
      epResumo.value = "";
      epStatus.value = "AINDA_NAO_COMECEI";
      epAvaliacao.value = "";
      document.getElementById("starsEp").textContent = "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
    }

    formEp.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!current) return;

      const payload = {
        midia_id: current.id,
        temporada: Number(epTemp.value),
        numero: Number(epNum.value),
        titulo: epTitulo.value.trim() || null,
        resumo: epResumo.value.trim() || null,
        status: epStatus.value,
        avaliacao: sanitizeRating(epAvaliacao.value)
      };

      if(!payload.temporada || !payload.numero){
        msg("Temporada e n√∫mero s√£o obrigat√≥rios.","err");
        return;
      }

      try{
        if(epId.value){
          const { error } = await db.from("episodios").update(payload).eq("id", Number(epId.value));
          if(error) throw error;
          msg("Epis√≥dio atualizado ‚úÖ","ok");
        }else{
          const { error } = await db.from("episodios").insert(payload);
          if(error) throw error;
          msg("Epis√≥dio salvo ‚úÖ","ok");
        }
        epFormBox.style.display = "none";
        clearEpForm();
        await loadEps(current.id);
      }catch(err){
        console.error(err);
        msg("Erro ao salvar epis√≥dio.","err");
      }
    });

    async function delEp(id){
      if(!confirm("Excluir epis√≥dio?")) return;
      const { error } = await db.from("episodios").delete().eq("id", id);
      if(error){
        console.error(error);
        msg("Erro ao excluir epis√≥dio.","err");
        return;
      }
      msg("Epis√≥dio exclu√≠do ‚úÖ","ok");
      await loadEps(current.id);
    }

    function editEp(ep){
      epFormBox.style.display = "block";
      epId.value = ep.id;
      epTemp.value = ep.temporada;
      epNum.value = ep.numero;
      epTitulo.value = ep.titulo || "";
      epResumo.value = ep.resumo || "";
      epStatus.value = ep.status || "AINDA_NAO_COMECEI";
      epAvaliacao.value = (sanitizeRating(ep.avaliacao) ?? "").toString().replace(".", ",");
      document.getElementById("starsEp").textContent = starsString(ep.avaliacao);
    }

    function groupEps(){
      const map = new Map();
      for(const ep of eps){
        const t = ep.temporada || 0;
        if(!map.has(t)) map.set(t, new Map());
        const st = ep.status || "AINDA_NAO_COMECEI";
        const m2 = map.get(t);
        if(!m2.has(st)) m2.set(st, []);
        m2.get(st).push(ep);
      }
      const seasons = [...map.keys()].sort((a,b)=>a-b);
      return {map, seasons};
    }

    function renderEpisodes(){
      epsGrouped.innerHTML = "";
      if(!current || current.tipo!=="SERIE") return;

      if(!eps.length){
        epsGrouped.innerHTML = `<div class="panel"><span class="small">Nenhum epis√≥dio cadastrado ainda.</span></div>`;
        return;
      }

      const { map, seasons } = groupEps();
      for(const temporada of seasons){
        const det = document.createElement("details");
        det.className = "ep";
        det.open = true;

        const totalSeason = [...map.get(temporada).values()].reduce((acc,arr)=>acc+arr.length,0);
        const sum = document.createElement("summary");
        sum.innerHTML = `Temporada ${temporada} <span class="small">(${totalSeason} epis√≥dio(s))</span>`;
        det.appendChild(sum);

        const wrap = document.createElement("div");
        wrap.className = "epWrap";

        const order = ["ASSISTINDO","ASSISTIDOS","AINDA_NAO_COMECEI"];
        for(const st of order){
          const list = map.get(temporada).get(st) || [];
          if(!list.length) continue;

          const title = document.createElement("div");
          title.className = "epGroupTitle";
          title.textContent = `${statusLabel(st)} (${list.length})`;
          wrap.appendChild(title);

          const table = document.createElement("table");
          table.className = "epTable";
          table.innerHTML = `
            <thead>
              <tr>
                <th style="width:90px">Epis√≥dio</th>
                <th>T√≠tulo / Resumo</th>
                <th style="width:140px">Nota</th>
                <th style="width:180px">A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          const tb = table.querySelector("tbody");
          list.sort((a,b)=>(a.numero||0)-(b.numero||0));

          for(const ep of list){
            const nota = sanitizeRating(ep.avaliacao);
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><b>E${String(ep.numero||0).padStart(2,"0")}</b></td>
              <td>
                <div style="font-weight:700">${escapeHtml(ep.titulo||"-")}</div>
                <div class="small" style="margin-top:2px;white-space:pre-wrap">${escapeHtml(ep.resumo||"")}</div>
              </td>
              <td>
                <div class="tag">
                  <span style="font-weight:700">${nota===null? "-" : String(nota).replace(".0","")}</span>
                  <span>${starsString(ep.avaliacao)}</span>
                </div>
              </td>
              <td></td>
            `;
            const td = tr.querySelector("td:last-child");
            const actions = document.createElement("div");
            actions.className = "epActions";

            const b1 = document.createElement("button");
            b1.className = "btn ghost small";
            b1.textContent = "Editar";
            b1.type = "button";
            b1.onclick = ()=>editEp(ep);

            const b2 = document.createElement("button");
            b2.className = "btn danger small";
            b2.textContent = "Excluir";
            b2.type = "button";
            b2.onclick = ()=>delEp(ep.id);

            actions.appendChild(b1);
            actions.appendChild(b2);
            td.appendChild(actions);

            tb.appendChild(tr);
          }

          wrap.appendChild(table);
          wrap.appendChild(document.createElement("div")).className="divider";
        }

        det.appendChild(wrap);
        epsGrouped.appendChild(det);
      }
    }

    // ========= TMDb integration =========
    async function tmdbFetch(path){
      const url = `https://api.themoviedb.org/3${path}`;
      const res = await fetch(url, {
        headers: { "Authorization": `Bearer ${TMDB_BEARER}`, "Content-Type": "application/json;charset=utf-8" }
      });
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`TMDb error ${res.status}: ${txt}`);
      }
      return res.json();
    }

    function showTmdbResults(items, type){
      tmdbResults.innerHTML = "";
      if(!items.length){
        tmdbResults.style.display = "block";
        tmdbResults.innerHTML = `<div class="small" style="padding:10px 12px">Nada encontrado.</div>`;
        return;
      }
      tmdbResults.style.display = "block";

      items.slice(0, 12).forEach(item=>{
        const name = type==="movie" ? item.title : item.name;
        const date = type==="movie" ? item.release_date : item.first_air_date;
        const year = (date||"").slice(0,4) || "-";
        const poster = item.poster_path ? (TMDB_IMG + item.poster_path) : safePoster("");

        const div = document.createElement("div");
        div.className = "tmdbItem";
        div.innerHTML = `
          <div class="tmdbThumb"><img src="${poster}" alt=""></div>
          <div style="min-width:0;flex:1">
            <div class="tmdbName">${escapeHtml(name||"-")}</div>
            <div class="tmdbMeta">${year} ‚Ä¢ ${escapeHtml((item.overview||"").slice(0,80))}${(item.overview||"").length>80?"...":""}</div>
          </div>
          <button class="btn secondary small" type="button">Usar</button>
        `;
        div.querySelector("button").onclick = async (e)=>{
          e.stopPropagation();
          await applyTmdbItem(type, item.id);
        };
        tmdbResults.appendChild(div);
      });
    }

    function pickTopCast(credits){
      const cast = (credits?.cast || []).slice(0, 12).map(c=>({
        id: c.id, name: c.name, character: c.character, order: c.order, profile_path: c.profile_path
      }));
      return cast;
    }
    function pickKeywords(type, kw){
      const arr = type==="movie" ? (kw?.keywords||[]) : (kw?.results||[]);
      return arr.slice(0, 30).map(k=>({ id:k.id, name:k.name }));
    }
    function packImages(images){
      return {
        posters: (images?.posters||[]).slice(0, 12),
        backdrops: (images?.backdrops||[]).slice(0, 12),
        logos: (images?.logos||[]).slice(0, 12)
      };
    }
    function packVideos(videos){
      return (videos?.results||[]).slice(0, 20).map(v=>({
        id:v.id, name:v.name, site:v.site, key:v.key, type:v.type, official:v.official, published_at:v.published_at
      }));
    }

    async function applyTmdbItem(type, id){
      try{
        msg("Buscando detalhes no TMDb...","ok");

        if(type==="movie"){
          const details = await tmdbFetch(`/movie/${id}?api_key=${TMDB_API_KEY}&language=pt-BR&append_to_response=credits,keywords,videos,images,external_ids,watch/providers`);
          const director = (details.credits?.crew||[]).filter(c=>c.job==="Director").map(c=>c.name).slice(0,3).join(", ");

          mTipo.value = "FILME";
          mTmdbId.value = String(details.id || "");
          mImdbId.value = details.external_ids?.imdb_id || "";
          mNome.value = details.title || mNome.value;
          mTituloOriginal.value = details.original_title || "";
          mIdiomaOriginal.value = details.original_language || "";
          mTagline.value = details.tagline || "";
          mStatusOficial.value = details.status || "";
          mSinopse.value = details.overview || mSinopse.value;

          mDataLancamento.value = details.release_date || "";
          if(details.release_date) mAno.value = String(details.release_date).slice(0,4);

          mImagemUrl.value = details.poster_path ? (TMDB_IMG + details.poster_path) : mImagemUrl.value;
          mPoster.src = safePoster(mImagemUrl.value);

          mVoteAverage.value = (details.vote_average ?? "");
          mVoteCount.value = (details.vote_count ?? "");
          mPopularity.value = (details.popularity ?? "");
          mRuntime.value = (details.runtime ?? "");

          mProdCompanies.value = toJsonString((details.production_companies||[]).map(x=>({id:x.id,name:x.name,logo_path:x.logo_path,origin_country:x.origin_country})));
          mProdCountries.value = toJsonString(details.production_countries||[]);
          mSpokenLang.value = toJsonString(details.spoken_languages||[]);
          mOriginCountry.value = toJsonString(details.origin_country||[]);

          mCast.value = toJsonString(pickTopCast(details.credits));       // <<< cast_data no banco, mCast no form
          mKeywords.value = toJsonString(pickKeywords("movie", details.keywords));
          mVideos.value = toJsonString(packVideos(details.videos));
          mImages.value = toJsonString(packImages(details.images));
          mWatchProviders.value = toJsonString(details["watch/providers"] || null);

          mCollection.value = toJsonString(details.belongs_to_collection || null);

          modalSub.textContent = director ? `TMDb preenchido ‚Ä¢ Diretor: ${director}` : "TMDb preenchido";
          msg("Preenchido pelo TMDb ‚úÖ","ok");
          return;
        }

        // TV
        const details = await tmdbFetch(`/tv/${id}?api_key=${TMDB_API_KEY}&language=pt-BR&append_to_response=credits,keywords,videos,images,external_ids,watch/providers`);
        const creators = (details.created_by||[]).map(x=>x.name).slice(0,3).join(", ");

        mTipo.value = "SERIE";
        mTmdbId.value = String(details.id || "");
        mImdbId.value = details.external_ids?.imdb_id || "";

        mNome.value = details.name || mNome.value;
        mTituloOriginal.value = details.original_name || "";
        mIdiomaOriginal.value = details.original_language || "";
        mTagline.value = details.tagline || "";
        mStatusOficial.value = details.status || "";
        mSinopse.value = details.overview || mSinopse.value;

        mFirstAir.value = details.first_air_date || "";
        mLastAir.value = details.last_air_date || "";
        if(details.first_air_date) mAno.value = String(details.first_air_date).slice(0,4);

        mImagemUrl.value = details.poster_path ? (TMDB_IMG + details.poster_path) : mImagemUrl.value;
        mPoster.src = safePoster(mImagemUrl.value);

        mVoteAverage.value = (details.vote_average ?? "");
        mVoteCount.value = (details.vote_count ?? "");
        mPopularity.value = (details.popularity ?? "");

        mEpRunTime.value = toJsonString(details.episode_run_time || []);
        mSeasons.value = (details.number_of_seasons ?? "");
        mEpisodes.value = (details.number_of_episodes ?? "");

        mProdCompanies.value = toJsonString((details.production_companies||[]).map(x=>({id:x.id,name:x.name,logo_path:x.logo_path,origin_country:x.origin_country})));
        mProdCountries.value = toJsonString(details.production_countries||[]);
        mSpokenLang.value = toJsonString(details.spoken_languages||[]);
        mNetworks.value = toJsonString(details.networks||[]);
        mOriginCountry.value = toJsonString(details.origin_country||[]);

        mCast.value = toJsonString(pickTopCast(details.credits));
        mKeywords.value = toJsonString(pickKeywords("tv", details.keywords));
        mVideos.value = toJsonString(packVideos(details.videos));
        mImages.value = toJsonString(packImages(details.images));
        mWatchProviders.value = toJsonString(details["watch/providers"] || null);

        mCollection.value = toJsonString(null);

        modalSub.textContent = creators ? `TMDb preenchido ‚Ä¢ Criadores: ${creators}` : "TMDb preenchido";
        msg("Preenchido pelo TMDb ‚úÖ","ok");
      }catch(err){
        console.error(err);
        msg("Erro no TMDb (veja o console).","err");
      }
    }

    btnTmdbSearch.onclick = async ()=>{
      const q = tmdbQuery.value.trim();
      if(!q){ msg("Digite algo para buscar.","err"); return; }
      try{
        const type = tmdbType.value;
        msg("Buscando no TMDb...","ok");
        const data = await tmdbFetch(`/search/${type}?api_key=${TMDB_API_KEY}&language=pt-BR&query=${encodeURIComponent(q)}&include_adult=false&page=1`);
        showTmdbResults(data.results||[], type);
      }catch(err){
        console.error(err);
        msg("Falha ao buscar no TMDb.","err");
      }
    };

    btnTmdbClear.onclick = ()=>{
      tmdbQuery.value = "";
      tmdbResults.style.display="none";
      tmdbResults.innerHTML="";
    };

    // ========= Filters events =========
    [fStatus,fTipo].forEach(el=>el.addEventListener("change", renderList));
    [fNome,fNota].forEach(el=>el.addEventListener("input", renderList));

    // ========= Init =========
    (async ()=>{ await loadMidias(false); })();
  </script>
</body>
</html>
